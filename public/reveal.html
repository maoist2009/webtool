<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reveal.js åœ¨çº¿ Markdown ç¼–è¾‘å™¨</title>

  <script src="https://gcore.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Reveal.js (gcore.jsdelivr) -->
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/black.css" id="revealTheme">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/monokai.css">

  <!-- CodeMirror (gcore.jsdelivr) -->
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.min.css">

  <style>
    html, body { height: 100%; }
    body { margin: 0; }

    .CodeMirror {
      height: 100%;
      font-size: 14px;
      line-height: 1.5;
    }

    #previewWrap { position: relative; }
    #previewWrap .reveal { height: 100%; width: 100%; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: .4rem;
      padding: .45rem .7rem;
      border-radius: .5rem;
      background: rgb(30 41 59);
      border: 1px solid rgb(51 65 85);
      color: rgb(226 232 240);
      font-size: 0.8rem;
      user-select: none;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .btn:hover { background: rgb(51 65 85); }
    .btn:active { transform: scale(0.97); }
    .btn.primary { background: rgb(37 99 235); border-color: rgb(30 64 175); }
    .btn.primary:hover { background: rgb(29 78 216); }
    .btn.danger { background: rgb(127 29 29); border-color: rgb(153 27 27); }
    .btn.danger:hover { background: rgb(153 27 27); }
    .btn.sm { padding: .3rem .5rem; font-size: 0.75rem; }
    .btn.icon-only { padding: .4rem; }
    .btn.ghost { background: transparent; border-color: transparent; }
    .btn.ghost:hover { background: rgb(51 65 85); }

    .chip {
      border: 1px solid rgb(51 65 85);
      background: rgb(15 23 42);
      color: rgb(148 163 184);
      border-radius: 9999px;
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      white-space: nowrap;
    }

    #toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 60;
      display: none;
      background: rgba(2, 6, 23, 0.95);
      border: 1px solid rgb(51 65 85);
      color: rgb(226 232 240);
      padding: 10px 16px;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
      max-width: min(680px, calc(100vw - 24px));
      font-size: 0.875rem;
    }

    #helpModal[aria-hidden="true"] { display: none; }

    /* Sidebar styles */
    .sidebar {
      transition: width 0.25s ease, min-width 0.25s ease, opacity 0.2s;
      overflow: hidden;
    }
    .sidebar.collapsed {
      width: 0 !important;
      min-width: 0 !important;
      border: none !important;
      opacity: 0;
      pointer-events: none;
    }

    /* Panel styles */
    .panel {
      transition: flex 0.25s ease, width 0.25s ease, opacity 0.2s;
      overflow: hidden;
    }
    .panel.hidden-panel {
      flex: 0 0 0 !important;
      width: 0 !important;
      min-width: 0 !important;
      border: none !important;
      opacity: 0;
      pointer-events: none;
      overflow: hidden;
    }

    /* File tree */
    .file-tree-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.15s;
    }
    .file-tree-item:hover { background: rgb(30 41 59); }
    .file-tree-item.active { background: rgb(37 99 235); color: white; }
    .file-tree-item.folder { font-weight: 500; }
    .file-tree-item .icon { width: 16px; text-align: center; flex-shrink: 0; }
    .file-tree-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-tree-item .actions { display: none; gap: 2px; }
    .file-tree-item:hover .actions { display: flex; }
    .file-tree-item .actions button {
      background: transparent;
      border: none;
      color: rgb(148 163 184);
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 11px;
    }
    .file-tree-item .actions button:hover { background: rgb(51 65 85); color: white; }

    .folder-children {
      margin-left: 14px;
      border-left: 1px solid rgb(51 65 85);
      padding-left: 6px;
    }
    .folder-children.collapsed { display: none; }

    /* Settings panel */
    .setting-group { margin-bottom: 12px; }
    .setting-group label {
      display: block;
      font-size: 12px;
      color: rgb(148 163 184);
      margin-bottom: 4px;
    }
    .setting-group select,
    .setting-group input[type="text"],
    .setting-group input[type="number"] {
      width: 100%;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid rgb(51 65 85);
      background: rgb(15 23 42);
      color: rgb(226 232 240);
      font-size: 13px;
    }
    .setting-group input[type="checkbox"] {
      accent-color: rgb(37 99 235);
    }

    /* Context menu */
    .context-menu {
      position: fixed;
      background: rgb(15 23 42);
      border: 1px solid rgb(51 65 85);
      border-radius: 8px;
      padding: 4px;
      z-index: 100;
      min-width: 140px;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
    }
    .context-menu-item {
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .context-menu-item:hover { background: rgb(30 41 59); }
    .context-menu-item.danger { color: rgb(248 113 113); }

    /* Section header */
    .section-header {
      font-size: 11px;
      font-weight: 600;
      color: rgb(100 116 139);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgb(51 65 85);
    }

    /* Toolbar toggle button active state */
    .toggle-btn.active {
      background: rgb(37 99 235);
      border-color: rgb(30 64 175);
    }

    /* Divider */
    .divider {
      width: 1px;
      height: 20px;
      background: rgb(51 65 85);
      margin: 0 4px;
    }
  </style>
</head>

<body class="h-screen bg-slate-950 text-slate-100">
  <div class="h-screen flex flex-col">
    <!-- Compact Header / Toolbar -->
    <header class="sticky top-0 z-40 border-b border-slate-800 bg-slate-900/95 backdrop-blur">
      <div class="px-2 py-2 flex items-center gap-1.5">
        <!-- Left toggle -->
        <button id="btnToggleLeft" class="btn icon-only toggle-btn" title="åˆ‡æ¢æ–‡ä»¶æ  (Ctrl+B)">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
        </button>

        <div class="divider"></div>

        <!-- Logo -->
        <div class="flex items-center gap-2 px-2">
          <div class="w-2 h-2 rounded-full bg-blue-500"></div>
          <span class="font-semibold text-sm">Reveal.js ç¼–è¾‘å™¨</span>
        </div>

        <div class="divider"></div>

        <!-- View toggles -->
        <button id="btnToggleEditor" class="btn sm toggle-btn active" title="æ˜¾ç¤º/éšè—ç¼–è¾‘å™¨">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          <span class="hidden sm:inline">ç¼–è¾‘</span>
        </button>
        <button id="btnTogglePreview" class="btn sm toggle-btn active" title="æ˜¾ç¤º/éšè—é¢„è§ˆ">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span class="hidden sm:inline">é¢„è§ˆ</span>
        </button>

        <div class="flex-1"></div>

        <!-- Status -->
        <div id="status" class="chip" aria-live="polite">å·²ä¿å­˜</div>

        <div class="divider"></div>

        <!-- Right toggle -->
        <button id="btnToggleRight" class="btn icon-only toggle-btn" title="åˆ‡æ¢èœå•æ ">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>

        <input id="fileInput" type="file" accept=".md,.markdown,.txt" class="hidden" />
        <input id="workspaceInput" type="file" accept=".json" class="hidden" />
      </div>
    </header>

    <main class="flex-1 min-h-0 flex">
      <!-- Left Sidebar - File Tree -->
      <aside id="leftSidebar" class="sidebar w-56 min-w-56 border-r border-slate-800 bg-slate-950 flex flex-col">
        <div class="p-2 border-b border-slate-800 flex items-center justify-between">
          <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">å·¥ä½œåŒº</span>
          <div class="flex gap-1">
            <button id="btnNewFile" class="btn sm icon-only" title="æ–°å»ºæ–‡ä»¶ (Ctrl+N)">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            </button>
            <button id="btnNewFolder" class="btn sm icon-only" title="æ–°å»ºæ–‡ä»¶å¤¹">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
            </button>
          </div>
        </div>
        <div id="fileTree" class="flex-1 overflow-auto p-2"></div>
      </aside>

      <!-- Main Content Area -->
      <div id="mainContent" class="flex-1 min-h-0 flex flex-col-reverse md:flex-row">
        <!-- Preview Panel (åœ¨ç§»åŠ¨ç«¯æ”¾ä¸Šé¢ï¼Œæ¡Œé¢ç«¯æ”¾å³è¾¹) -->
        <section id="previewPanel" class="panel flex-1 min-h-0 flex flex-col order-first md:order-last">
          <div class="px-3 py-1.5 border-b md:border-b border-t md:border-t-0 border-slate-800 bg-slate-900/50 flex items-center gap-2">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-slate-500"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            <span class="text-xs text-slate-300 font-medium">é¢„è§ˆ</span>
            <span class="text-xs text-slate-500 hidden sm:inline">æ–¹å‘é”®ç¿»é¡µ</span>
            <div class="ml-auto flex items-center gap-1">
              <button id="btnFullscreen" class="btn sm" title="å…¨å±æ”¾æ˜  (Alt+Enter)">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                <span>æ”¾æ˜ </span>
              </button>
            </div>
          </div>
          <div id="previewWrap" class="flex-1 min-h-0 overflow-hidden bg-black">
            <div id="revealRoot" class="reveal">
              <div id="slides" class="slides"></div>
            </div>
          </div>
        </section>

        <!-- Editor Panel (åœ¨ç§»åŠ¨ç«¯æ”¾ä¸‹é¢ï¼Œæ¡Œé¢ç«¯æ”¾å·¦è¾¹) -->
        <section id="editorPanel" class="panel flex-1 min-h-0 flex flex-col order-last md:order-first md:border-r border-slate-800">
          <div class="px-3 py-1.5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-2">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-slate-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            <span id="currentFileName" class="text-xs text-slate-300 font-medium truncate"></span>
            <div class="ml-auto text-xs text-slate-500">Ctrl+S ä¿å­˜</div>
          </div>
          <div class="flex-1 min-h-0" id="editor"></div>
        </section>
      </div>

      <!-- Right Sidebar - Menu & Settings -->
      <aside id="rightSidebar" class="sidebar w-64 min-w-64 border-l border-slate-800 bg-slate-950 flex flex-col">
        <div class="flex-1 overflow-auto">
          <!-- Actions Section -->
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">æ–‡ä»¶æ“ä½œ</div>
            <div class="grid grid-cols-2 gap-1.5">
              <button id="btnSave" class="btn primary w-full" title="Ctrl+S">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                ä¿å­˜
              </button>
              <button id="btnExport" class="btn w-full" title="å¯¼å‡ºå½“å‰æ–‡ä»¶">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                å¯¼å‡º
              </button>
              <button id="btnImport" class="btn w-full" title="å¯¼å…¥ .md æ–‡ä»¶">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                å¯¼å…¥
              </button>
              <button id="btnHelp" class="btn w-full" title="ä½¿ç”¨è¯´æ˜">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                å¸®åŠ©
              </button>
            </div>
          </div>

          <!-- Workspace Section -->
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">å·¥ä½œåŒº</div>
            <div class="grid grid-cols-2 gap-1.5">
              <button id="btnExportWorkspace" class="btn w-full text-xs" title="å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                å¯¼å‡ºå…¨éƒ¨
              </button>
              <button id="btnImportWorkspace" class="btn w-full text-xs" title="å¯¼å…¥å·¥ä½œåŒº">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                å¯¼å…¥å…¨éƒ¨
              </button>
            </div>
            <button id="btnClearWorkspace" class="btn danger w-full mt-2 text-xs">
              <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              æ¸…ç©ºå·¥ä½œåŒº
            </button>
          </div>

          <!-- Editor Settings -->
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">ç¼–è¾‘å™¨è®¾ç½®</div>
            <div class="setting-group">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="settingAutoSave" checked />
                <span>è‡ªåŠ¨ä¿å­˜</span>
              </label>
            </div>
            <div class="setting-group">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="settingLineWrap" checked />
                <span>è‡ªåŠ¨æ¢è¡Œ</span>
              </label>
            </div>
            <div class="setting-group">
              <label>å­—ä½“å¤§å°</label>
              <select id="settingFontSize">
                <option value="12">12px</option>
                <option value="14" selected>14px</option>
                <option value="16">16px</option>
                <option value="18">18px</option>
              </select>
            </div>
          </div>

          <!-- Reveal Settings -->
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">æ¼”ç¤ºæ–‡ç¨¿</div>
            <div class="setting-group">
              <label>ä¸»é¢˜</label>
              <select id="settingTheme">
                <option value="black">Black</option>
                <option value="white">White</option>
                <option value="league">League</option>
                <option value="beige">Beige</option>
                <option value="sky">Sky</option>
                <option value="night">Night</option>
                <option value="serif">Serif</option>
                <option value="simple">Simple</option>
                <option value="solarized">Solarized</option>
                <option value="moon">Moon</option>
                <option value="dracula">Dracula</option>
              </select>
            </div>
            <div class="setting-group">
              <label>åˆ‡æ¢æ•ˆæœ</label>
              <select id="settingTransition">
                <option value="none">æ— </option>
                <option value="fade">æ·¡å…¥æ·¡å‡º</option>
                <option value="slide" selected>æ»‘åŠ¨</option>
                <option value="convex">å‡¸å‡º</option>
                <option value="concave">å‡¹å…¥</option>
                <option value="zoom">ç¼©æ”¾</option>
              </select>
            </div>
            <div class="setting-group">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="settingControls" checked />
                <span>æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®</span>
              </label>
            </div>
            <div class="setting-group">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="settingProgress" checked />
                <span>æ˜¾ç¤ºè¿›åº¦æ¡</span>
              </label>
            </div>
            <div class="setting-group">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="settingSlideNumber" checked />
                <span>æ˜¾ç¤ºé¡µç </span>
              </label>
            </div>
          </div>

          <!-- Shortcuts -->
          <div class="p-3">
            <div class="section-header">å¿«æ·é”®</div>
            <div class="text-xs text-slate-400 space-y-1">
              <div class="flex justify-between"><span>ä¿å­˜</span><span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded">Ctrl+S</span></div>
              <div class="flex justify-between"><span>å…¨å±æ”¾æ˜ </span><span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded">Alt+Enter</span></div>
              <div class="flex justify-between"><span>æ–°å»ºæ–‡ä»¶</span><span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded">Ctrl+N</span></div>
              <div class="flex justify-between"><span>åˆ‡æ¢æ–‡ä»¶æ </span><span class="font-mono bg-slate-800 px-1.5 py-0.5 rounded">Ctrl+B</span></div>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Context Menu -->
  <div id="contextMenu" class="context-menu" style="display: none;"></div>

  <!-- Help Modal -->
  <div id="helpModal" aria-hidden="true" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70" data-close="true"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-xl border border-slate-700 bg-slate-950 shadow-2xl">
        <div class="p-4 border-b border-slate-800 flex items-center gap-2">
          <div class="font-semibold">ä½¿ç”¨è¯´æ˜</div>
          <button class="ml-auto btn sm" data-close="true" type="button">å…³é—­</button>
        </div>
        <div class="p-4 space-y-3 text-sm text-slate-200 max-h-[70vh] overflow-auto">
          <div class="text-slate-300">è¿™æ˜¯ä¸€ä¸ªåŸºäº <span class="font-semibold text-blue-400">Markdown â†’ Reveal.js</span> çš„åœ¨çº¿å¹»ç¯ç‰‡ç¼–è¾‘å™¨ã€‚</div>
          
          <div class="section-header mt-4">å¹»ç¯ç‰‡åˆ†éš”</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li><code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">---</code>ï¼šæ¨ªå‘åˆ†é¡µï¼ˆä¸‹ä¸€å¼ ï¼‰</li>
            <li><code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">--</code>ï¼šçºµå‘åˆ†é¡µï¼ˆä¸‹é’»ï¼‰</li>
          </ul>

          <div class="section-header mt-4">ç•Œé¢å¸ƒå±€</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>é¡¶éƒ¨å·¥å…·æ å¯åˆ‡æ¢ç¼–è¾‘å™¨/é¢„è§ˆçš„æ˜¾ç¤º</li>
            <li>å·¦ä¾§è¾¹æ ï¼šæ–‡ä»¶å¤¹ç»“æ„ç®¡ç†</li>
            <li>å³ä¾§è¾¹æ ï¼šæ“ä½œæŒ‰é’®å’Œè®¾ç½®</li>
            <li>æ‰€æœ‰è¾¹æ éƒ½å¯ä»¥æŠ˜å éšè—</li>
          </ul>

          <div class="section-header mt-4">æ–‡ä»¶ç®¡ç†</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>å·¦ä¾§è¾¹æ æ”¯æŒåˆ›å»ºæ–‡ä»¶å’Œæ–‡ä»¶å¤¹</li>
            <li>å³é”®æ–‡ä»¶/æ–‡ä»¶å¤¹å¯é‡å‘½åæˆ–åˆ é™¤</li>
            <li>æ”¯æŒå¯¼å…¥/å¯¼å‡ºå•ä¸ªæ–‡ä»¶æˆ–æ•´ä¸ªå·¥ä½œåŒº</li>
            <li>æ”¯æŒæ‹–æ‹½ .md æ–‡ä»¶åˆ°ç¼–è¾‘åŒºå¯¼å…¥</li>
          </ul>

          <div class="rounded-lg border border-slate-800 bg-slate-900/50 p-3 mt-4">
            <div class="text-xs uppercase tracking-wider text-slate-400 mb-2">ç¤ºä¾‹</div>
            <pre class="text-xs text-slate-200 overflow-auto"><code># ç¬¬ä¸€å¼ å¹»ç¯ç‰‡

---

## ç¬¬äºŒå¼ ï¼ˆæ¨ªå‘ï¼‰

--

### ç¬¬äºŒå¼ çš„å­é¡µé¢ï¼ˆçºµå‘ï¼‰

```js
console.log('ä»£ç é«˜äº®')
```</code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="renameModal" aria-hidden="true" class="fixed inset-0 z-50" style="display: none;">
    <div class="absolute inset-0 bg-black/70" data-close="true"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-sm rounded-xl border border-slate-700 bg-slate-950 shadow-2xl">
        <div class="p-4 border-b border-slate-800">
          <div class="font-semibold" id="renameModalTitle">é‡å‘½å</div>
        </div>
        <div class="p-4">
          <input type="text" id="renameInput" class="w-full px-3 py-2 rounded-lg border border-slate-700 bg-slate-900 text-white focus:outline-none focus:border-blue-500" />
        </div>
        <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
          <button class="btn" data-close="true">å–æ¶ˆ</button>
          <button id="renameConfirm" class="btn primary">ç¡®å®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies (gcore.jsdelivr) -->
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/meta.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/css/css.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>

  <script src="https://gcore.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>

  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/notes/notes.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/highlight.js"></script>

  <script>
    (() => {
      const WORKSPACE_KEY = 'reveal_md_workspace_v3';
      const SETTINGS_KEY = 'reveal_md_settings_v3';
      const UI_STATE_KEY = 'reveal_md_ui_state_v2';

      const $ = (sel) => document.querySelector(sel);
      const toastEl = $('#toast');

      function toast(msg) {
        toastEl.textContent = msg;
        toastEl.style.display = 'block';
        clearTimeout(toastEl.__t);
        toastEl.__t = setTimeout(() => (toastEl.style.display = 'none'), 2000);
      }

      function debounce(fn, wait) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
      }

      const defaultMd = `# Reveal.js åœ¨çº¿ç¼–è¾‘å™¨

æ¬¢è¿ä½¿ç”¨ï¼è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„ Markdown å¹»ç¯ç‰‡ç¼–è¾‘å™¨ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½

- ğŸ“ å·¦ä¾§ï¼šæ–‡ä»¶å¤¹ç»“æ„ç®¡ç†
- âœï¸ ä¸­é—´ï¼šMarkdown ç¼–è¾‘å™¨
- âš™ï¸ å³ä¾§ï¼šæ“ä½œä¸è®¾ç½®é¢æ¿
- ğŸ¬ é¡¶éƒ¨ï¼šè§†å›¾åˆ‡æ¢æ§åˆ¶

---

## åˆ†éš”ç¬¦è¯­æ³•

- \`---\`ï¼šæ¨ªå‘åˆ†é¡µï¼ˆä¸‹ä¸€å¼ ï¼‰
- \`--\`ï¼šçºµå‘åˆ†é¡µï¼ˆä¸‹é’»å­é¡µé¢ï¼‰

--

### è¿™æ˜¯çºµå‘å­é¡µé¢

\`\`\`javascript
// æ”¯æŒä»£ç é«˜äº®
console.log('Hello Reveal.js!')
\`\`\`

---

## å¿«æ·é”®

| åŠŸèƒ½ | å¿«æ·é”® |
|------|--------|
| ä¿å­˜ | Ctrl+S |
| å…¨å±æ”¾æ˜  | Alt+Enter |
| æ–°å»ºæ–‡ä»¶ | Ctrl+N |
| åˆ‡æ¢æ–‡ä»¶æ  | Ctrl+B |

---

## å¼€å§‹ä½¿ç”¨

1. åœ¨å·¦ä¾§åˆ›å»ºæˆ–é€‰æ‹©æ–‡ä»¶
2. åœ¨ç¼–è¾‘å™¨ä¸­ä¹¦å†™ Markdown
3. å³ä¾§é¢„è§ˆå®æ—¶æ›´æ–°
4. ç‚¹å‡»ã€Œæ”¾æ˜ ã€è¿›å…¥å…¨å±æ¼”ç¤º`;

      // Workspace structure
      let workspace = {
        files: {},
        activeFileId: null,
        expandedFolders: []
      };

      let settings = {
        autoSave: true,
        lineWrap: true,
        fontSize: 14,
        theme: 'black',
        transition: 'slide',
        controls: true,
        progress: true,
        slideNumber: true
      };

      let uiState = {
        leftSidebarOpen: true,
        rightSidebarOpen: true,
        editorVisible: true,
        previewVisible: true
      };

      // Load saved data
      try {
        const savedWorkspace = JSON.parse(localStorage.getItem(WORKSPACE_KEY));
        if (savedWorkspace && savedWorkspace.files) workspace = savedWorkspace;
      } catch (_) {}

      try {
        const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY));
        if (savedSettings) settings = { ...settings, ...savedSettings };
      } catch (_) {}

      try {
        const savedUi = JSON.parse(localStorage.getItem(UI_STATE_KEY));
        if (savedUi) uiState = { ...uiState, ...savedUi };
      } catch (_) {}

      // Initialize with default file if empty
      if (Object.keys(workspace.files).length === 0) {
        const defaultId = generateId();
        workspace.files[defaultId] = {
          name: 'æ¬¢è¿.md',
          content: defaultMd,
          parentId: null,
          type: 'file'
        };
        workspace.activeFileId = defaultId;
      }

      // Marked config
      marked.setOptions({ gfm: true, breaks: false, headerIds: false, mangle: false });

      const statusEl = $('#status');
      let dirty = false;
      let deck = null;
      let cm = null;
      let contextMenuTarget = null;

      function setDirty(v) {
        dirty = v;
        renderStatus();
      }

      function renderStatus(extra) {
        const text = dirty ? 'æœªä¿å­˜' : 'å·²ä¿å­˜';
        statusEl.textContent = extra ? `${text} Â· ${extra}` : text;
        statusEl.style.borderColor = dirty ? 'rgb(234 179 8)' : 'rgb(34 197 94)';
        statusEl.style.color = dirty ? 'rgb(250 204 21)' : 'rgb(134 239 172)';
      }

      function nowTime() {
        return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }

      function saveWorkspace() {
        localStorage.setItem(WORKSPACE_KEY, JSON.stringify(workspace));
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        localStorage.setItem(UI_STATE_KEY, JSON.stringify(uiState));
      }

      function saveCurrentFile({ silent = false } = {}) {
        if (!workspace.activeFileId || !workspace.files[workspace.activeFileId]) return;
        workspace.files[workspace.activeFileId].content = cm.getValue();
        saveWorkspace();
        setDirty(false);
        renderStatus(nowTime());
        if (!silent) toast('å·²ä¿å­˜');
      }

      function loadFile(fileId) {
        if (!workspace.files[fileId] || workspace.files[fileId].type !== 'file') return;
        
        if (workspace.activeFileId && workspace.files[workspace.activeFileId]) {
          workspace.files[workspace.activeFileId].content = cm.getValue();
        }
        
        workspace.activeFileId = fileId;
        const file = workspace.files[fileId];
        cm.setValue(file.content || '');
        $('#currentFileName').textContent = file.name;
        setDirty(false);
        saveWorkspace();
        renderFileTree();
        requestPreviewUpdate();
      }

      function createFile(name, parentId = null) {
        const id = generateId();
        workspace.files[id] = {
          name: name || 'æœªå‘½å.md',
          content: '',
          parentId,
          type: 'file'
        };
        saveWorkspace();
        renderFileTree();
        loadFile(id);
        toast('å·²åˆ›å»ºæ–‡ä»¶');
      }

      function createFolder(name, parentId = null) {
        const id = generateId();
        workspace.files[id] = {
          name: name || 'æ–°æ–‡ä»¶å¤¹',
          parentId,
          type: 'folder'
        };
        if (!workspace.expandedFolders.includes(id)) {
          workspace.expandedFolders.push(id);
        }
        saveWorkspace();
        renderFileTree();
        toast('å·²åˆ›å»ºæ–‡ä»¶å¤¹');
      }

      function deleteItem(id) {
        const item = workspace.files[id];
        if (!item) return;
        
        if (item.type === 'folder') {
          Object.keys(workspace.files).forEach(fid => {
            if (workspace.files[fid].parentId === id) deleteItem(fid);
          });
        }
        
        delete workspace.files[id];
        
        if (workspace.activeFileId === id) {
          const files = Object.entries(workspace.files).filter(([_, f]) => f.type === 'file');
          workspace.activeFileId = files.length > 0 ? files[0][0] : null;
          if (workspace.activeFileId) {
            loadFile(workspace.activeFileId);
          } else {
            cm.setValue('');
            $('#currentFileName').textContent = '';
          }
        }
        
        saveWorkspace();
        renderFileTree();
        toast('å·²åˆ é™¤');
      }

      function renameItem(id, newName) {
        if (!workspace.files[id]) return;
        workspace.files[id].name = newName;
        saveWorkspace();
        renderFileTree();
        if (workspace.activeFileId === id) {
          $('#currentFileName').textContent = newName;
        }
        toast('å·²é‡å‘½å');
      }

      function toggleFolder(id) {
        const idx = workspace.expandedFolders.indexOf(id);
        if (idx > -1) {
          workspace.expandedFolders.splice(idx, 1);
        } else {
          workspace.expandedFolders.push(id);
        }
        saveWorkspace();
        renderFileTree();
      }

      function renderFileTree() {
        const container = $('#fileTree');
        container.innerHTML = '';
        
        function renderItems(parentId) {
          const items = Object.entries(workspace.files)
            .filter(([_, item]) => item.parentId === parentId)
            .sort((a, b) => {
              if (a[1].type !== b[1].type) return a[1].type === 'folder' ? -1 : 1;
              return a[1].name.localeCompare(b[1].name);
            });
          
          const fragment = document.createDocumentFragment();
          
          items.forEach(([id, item]) => {
            const div = document.createElement('div');
            div.className = 'file-tree-item' + (item.type === 'folder' ? ' folder' : '') + (workspace.activeFileId === id ? ' active' : '');
            div.dataset.id = id;
            div.dataset.type = item.type;
            
            const isExpanded = workspace.expandedFolders.includes(id);
            
            div.innerHTML = `
              <span class="icon">${item.type === 'folder' ? (isExpanded ? 'ğŸ“‚' : 'ğŸ“') : 'ğŸ“„'}</span>
              <span class="name">${item.name}</span>
              <span class="actions">
                <button data-action="rename" title="é‡å‘½å">âœï¸</button>
                <button data-action="delete" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </span>
            `;
            
            div.addEventListener('click', (e) => {
              if (e.target.dataset.action) return;
              if (item.type === 'folder') {
                toggleFolder(id);
              } else {
                loadFile(id);
              }
            });
            
            div.addEventListener('contextmenu', (e) => {
              e.preventDefault();
              showContextMenu(e, id);
            });
            
            div.querySelectorAll('[data-action]').forEach(btn => {
              btn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (btn.dataset.action === 'rename') {
                  openRenameModal(id);
                } else if (btn.dataset.action === 'delete') {
                  if (confirm(`ç¡®å®šåˆ é™¤ "${item.name}"ï¼Ÿ`)) deleteItem(id);
                }
              });
            });
            
            fragment.appendChild(div);
            
            if (item.type === 'folder') {
              const children = document.createElement('div');
              children.className = 'folder-children' + (isExpanded ? '' : ' collapsed');
              const childItems = renderItems(id);
              if (childItems.childNodes.length > 0) children.appendChild(childItems);
              fragment.appendChild(children);
            }
          });
          
          return fragment;
        }
        
        container.appendChild(renderItems(null));
      }

      function showContextMenu(e, id) {
        contextMenuTarget = id;
        const menu = $('#contextMenu');
        const item = workspace.files[id];
        
        menu.innerHTML = `
          ${item.type === 'folder' ? `
            <div class="context-menu-item" data-action="newFile">ğŸ“„ æ–°å»ºæ–‡ä»¶</div>
            <div class="context-menu-item" data-action="newFolder">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</div>
          ` : ''}
          <div class="context-menu-item" data-action="rename">âœï¸ é‡å‘½å</div>
          <div class="context-menu-item danger" data-action="delete">ğŸ—‘ï¸ åˆ é™¤</div>
        `;
        
        menu.style.display = 'block';
        menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px';
        menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px';
      }

      document.addEventListener('click', () => {
        $('#contextMenu').style.display = 'none';
      });

      $('#contextMenu').addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (!action || !contextMenuTarget) return;
        
        const item = workspace.files[contextMenuTarget];
        
        if (action === 'rename') {
          openRenameModal(contextMenuTarget);
        } else if (action === 'delete') {
          if (confirm(`ç¡®å®šåˆ é™¤ "${item.name}"ï¼Ÿ`)) deleteItem(contextMenuTarget);
        } else if (action === 'newFile') {
          createFile('æœªå‘½å.md', contextMenuTarget);
        } else if (action === 'newFolder') {
          createFolder('æ–°æ–‡ä»¶å¤¹', contextMenuTarget);
        }
        
        $('#contextMenu').style.display = 'none';
      });

      let renameTargetId = null;
      
      function openRenameModal(id) {
        renameTargetId = id;
        const item = workspace.files[id];
        $('#renameModalTitle').textContent = item.type === 'folder' ? 'é‡å‘½åæ–‡ä»¶å¤¹' : 'é‡å‘½åæ–‡ä»¶';
        $('#renameInput').value = item.name;
        $('#renameModal').style.display = 'block';
        $('#renameModal').setAttribute('aria-hidden', 'false');
        setTimeout(() => $('#renameInput').select(), 50);
      }

      function closeRenameModal() {
        $('#renameModal').style.display = 'none';
        $('#renameModal').setAttribute('aria-hidden', 'true');
        renameTargetId = null;
      }

      $('#renameModal').addEventListener('click', (e) => {
        if (e.target.dataset.close) closeRenameModal();
      });

      $('#renameConfirm').addEventListener('click', () => {
        const newName = $('#renameInput').value.trim();
        if (newName && renameTargetId) renameItem(renameTargetId, newName);
        closeRenameModal();
      });

      $('#renameInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') $('#renameConfirm').click();
        else if (e.key === 'Escape') closeRenameModal();
      });

      // Export/Import workspace
      function exportWorkspace() {
        const data = {
          version: 3,
          exportDate: new Date().toISOString(),
          workspace,
          settings
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `reveal-workspace-${stamp}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast('å·²å¯¼å‡ºå·¥ä½œåŒº');
      }

      function importWorkspace(file) {
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (!data.workspace || !data.workspace.files) throw new Error('Invalid');
            
            // é‡è¦ï¼šå…ˆæ¸…é™¤å½“å‰çš„ activeFileIdï¼Œé˜²æ­¢ loadFile æ—¶ä¿å­˜æ—§å†…å®¹åˆ°æ–°å·¥ä½œåŒº
            const oldActiveId = workspace.activeFileId;
            workspace.activeFileId = null;
            
            // æ›¿æ¢ä¸ºæ–°å·¥ä½œåŒº
            workspace = data.workspace;
            if (data.settings) {
              settings = { ...settings, ...data.settings };
              applySettings();
            }
            saveWorkspace();
            renderFileTree();
            
            // åŠ è½½æ´»åŠ¨æ–‡ä»¶ï¼ˆä¸ä¼šè§¦å‘ä¿å­˜æ—§å†…å®¹ï¼Œå› ä¸ºä¸Šé¢å·²ç»å¤„ç†äº†ï¼‰
            let targetFileId = workspace.activeFileId;
            if (!targetFileId || !workspace.files[targetFileId]) {
              const files = Object.entries(workspace.files).filter(([_, f]) => f.type === 'file');
              targetFileId = files.length > 0 ? files[0][0] : null;
            }
            
            if (targetFileId && workspace.files[targetFileId]) {
              // ç›´æ¥è®¾ç½®ç¼–è¾‘å™¨å†…å®¹ï¼Œä¸é€šè¿‡ loadFileï¼ˆé¿å…ä¿å­˜æ—§å†…å®¹ï¼‰
              workspace.activeFileId = targetFileId;
              const file = workspace.files[targetFileId];
              cm.setValue(file.content || '');
              $('#currentFileName').textContent = file.name;
              setDirty(false);
              saveWorkspace();
              renderFileTree();
              requestPreviewUpdate();
            } else {
              cm.setValue('');
              $('#currentFileName').textContent = '';
            }
            
            toast('å·²å¯¼å…¥å·¥ä½œåŒº');
          } catch (e) {
            toast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
          }
        };
        reader.readAsText(file);
      }

      // UI State handlers
      function updateToggleButtons() {
        $('#btnToggleLeft').classList.toggle('active', uiState.leftSidebarOpen);
        $('#btnToggleRight').classList.toggle('active', uiState.rightSidebarOpen);
        $('#btnToggleEditor').classList.toggle('active', uiState.editorVisible);
        $('#btnTogglePreview').classList.toggle('active', uiState.previewVisible);
      }

      function toggleLeftSidebar() {
        uiState.leftSidebarOpen = !uiState.leftSidebarOpen;
        $('#leftSidebar').classList.toggle('collapsed', !uiState.leftSidebarOpen);
        updateToggleButtons();
        saveWorkspace();
        setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250);
      }

      function toggleRightSidebar() {
        uiState.rightSidebarOpen = !uiState.rightSidebarOpen;
        $('#rightSidebar').classList.toggle('collapsed', !uiState.rightSidebarOpen);
        updateToggleButtons();
        saveWorkspace();
        setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250);
      }

      function toggleEditor() {
        // Don't allow hiding both panels
        if (uiState.editorVisible && !uiState.previewVisible) {
          toast('è‡³å°‘éœ€è¦æ˜¾ç¤ºä¸€ä¸ªé¢æ¿');
          return;
        }
        uiState.editorVisible = !uiState.editorVisible;
        $('#editorPanel').classList.toggle('hidden-panel', !uiState.editorVisible);
        updateToggleButtons();
        saveWorkspace();
        setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250);
      }

      function togglePreview() {
        // Don't allow hiding both panels
        if (uiState.previewVisible && !uiState.editorVisible) {
          toast('è‡³å°‘éœ€è¦æ˜¾ç¤ºä¸€ä¸ªé¢æ¿');
          return;
        }
        uiState.previewVisible = !uiState.previewVisible;
        $('#previewPanel').classList.toggle('hidden-panel', !uiState.previewVisible);
        updateToggleButtons();
        saveWorkspace();
        setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250);
      }

      // Apply initial UI state
      if (!uiState.leftSidebarOpen) $('#leftSidebar').classList.add('collapsed');
      if (!uiState.rightSidebarOpen) $('#rightSidebar').classList.add('collapsed');
      if (!uiState.editorVisible) $('#editorPanel').classList.add('hidden-panel');
      if (!uiState.previewVisible) $('#previewPanel').classList.add('hidden-panel');
      updateToggleButtons();

      // Settings handlers
      function applySettings() {
        $('#settingAutoSave').checked = settings.autoSave;
        $('#settingLineWrap').checked = settings.lineWrap;
        $('#settingFontSize').value = settings.fontSize;
        $('#settingTheme').value = settings.theme;
        $('#settingTransition').value = settings.transition;
        $('#settingControls').checked = settings.controls;
        $('#settingProgress').checked = settings.progress;
        $('#settingSlideNumber').checked = settings.slideNumber;
        
        const themeLink = $('#revealTheme');
        themeLink.href = `https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/${settings.theme}.css`;
        
        if (cm) {
          cm.setOption('lineWrapping', settings.lineWrap);
          document.querySelector('.CodeMirror').style.fontSize = settings.fontSize + 'px';
        }
        
        if (deck) {
          deck.configure({
            transition: settings.transition,
            controls: settings.controls,
            progress: settings.progress,
            slideNumber: settings.slideNumber
          });
        }
      }

      // Setting change handlers
      $('#settingAutoSave').addEventListener('change', (e) => {
        settings.autoSave = e.target.checked;
        saveWorkspace();
        toast(settings.autoSave ? 'è‡ªåŠ¨ä¿å­˜ï¼šå¼€å¯' : 'è‡ªåŠ¨ä¿å­˜ï¼šå…³é—­');
      });

      $('#settingLineWrap').addEventListener('change', (e) => {
        settings.lineWrap = e.target.checked;
        cm.setOption('lineWrapping', settings.lineWrap);
        saveWorkspace();
      });

      $('#settingFontSize').addEventListener('change', (e) => {
        settings.fontSize = parseInt(e.target.value);
        document.querySelector('.CodeMirror').style.fontSize = settings.fontSize + 'px';
        cm.refresh();
        saveWorkspace();
      });

      $('#settingTheme').addEventListener('change', (e) => {
        settings.theme = e.target.value;
        $('#revealTheme').href = `https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/${settings.theme}.css`;
        saveWorkspace();
      });

      $('#settingTransition').addEventListener('change', (e) => {
        settings.transition = e.target.value;
        if (deck) deck.configure({ transition: settings.transition });
        saveWorkspace();
      });

      $('#settingControls').addEventListener('change', (e) => {
        settings.controls = e.target.checked;
        if (deck) deck.configure({ controls: settings.controls });
        saveWorkspace();
      });

      $('#settingProgress').addEventListener('change', (e) => {
        settings.progress = e.target.checked;
        if (deck) deck.configure({ progress: settings.progress });
        saveWorkspace();
      });

      $('#settingSlideNumber').addEventListener('change', (e) => {
        settings.slideNumber = e.target.checked;
        if (deck) deck.configure({ slideNumber: settings.slideNumber });
        saveWorkspace();
      });

      // Slide building
      function splitSlides(md) {
        const normalized = String(md || '').replace(/\r\n/g, '\n');
        const h = normalized.split(/\n\s*---\s*\n/g);
        return h.map(part => part.split(/\n\s*--\s*\n/g));
      }

      function renderSlideMarkdown(mdChunk) {
        const src = String(mdChunk || '').trim();
        if (!src) return '<p style="opacity:0.5">ï¼ˆç©ºç™½é¡µï¼‰</p>';
        return marked.parse(src);
      }

      function buildSlidesHtml(md) {
        const groups = splitSlides(md);
        let out = '';
        for (const verticalGroup of groups) {
          if (verticalGroup.length > 1) {
            out += '<section>';
            for (const v of verticalGroup) {
              out += `<section>${renderSlideMarkdown(v)}</section>`;
            }
            out += '</section>';
          } else {
            out += `<section>${renderSlideMarkdown(verticalGroup[0])}</section>`;
          }
        }
        return out;
      }

      async function ensureDeck() {
        if (deck) return deck;

        deck = new Reveal($('#revealRoot'), {
          embedded: true,
          hash: false,
          controls: settings.controls,
          progress: settings.progress,
          slideNumber: settings.slideNumber,
          center: true,
          transition: settings.transition,
          backgroundTransition: 'fade',
          touch: true,
          plugins: [RevealNotes, RevealHighlight],
          keyboardCondition: (event) => {
            const ae = document.activeElement;
            const editorPanel = $('#editorPanel');
            if (ae && editorPanel && editorPanel.contains(ae)) return false;
            return true;
          }
        });

        await deck.initialize();
        deck.layout();
        return deck;
      }

      function highlightPreview() {
        try {
          if (window.hljs && typeof window.hljs.highlightAll === 'function') {
            window.hljs.highlightAll();
          }
        } catch (_) {}
      }

      const requestPreviewUpdate = debounce(async () => {
        const md = cm.getValue();
        const slidesEl = $('#slides');

        const idx = deck ? deck.getIndices() : { h: 0, v: 0, f: 0 };
        slidesEl.innerHTML = buildSlidesHtml(md);

        const d = await ensureDeck();
        d.sync();
        d.layout();
        try { d.slide(idx.h, idx.v, idx.f); } catch (_) {}
        setTimeout(highlightPreview, 0);

        if (settings.autoSave) {
          saveCurrentFile({ silent: true });
        }
      }, 260);

      // Initialize CodeMirror
      const initialContent = workspace.activeFileId && workspace.files[workspace.activeFileId] 
        ? workspace.files[workspace.activeFileId].content 
        : '';
      
      cm = CodeMirror($('#editor'), {
        value: initialContent,
        mode: { name: 'markdown', fencedCodeBlocks: true, strikethrough: true, taskLists: true },
        theme: 'material-darker',
        lineNumbers: true,
        lineWrapping: settings.lineWrap,
        indentUnit: 2,
        tabSize: 2,
        autofocus: false,
        extraKeys: {
          'Ctrl-S': () => saveCurrentFile(),
          'Cmd-S': () => saveCurrentFile(),
          'Alt-Enter': () => toggleFullscreen(),
          'Ctrl-N': () => createFile(),
          'Cmd-N': () => createFile(),
          'Ctrl-B': () => toggleLeftSidebar(),
          'Cmd-B': () => toggleLeftSidebar(),
        }
      });

      applySettings();

      if (workspace.activeFileId && workspace.files[workspace.activeFileId]) {
        $('#currentFileName').textContent = workspace.files[workspace.activeFileId].name;
      }

      renderStatus('å·²åŠ è½½');
      renderFileTree();
      $('#slides').innerHTML = buildSlidesHtml(initialContent);
      ensureDeck().then(() => setTimeout(highlightPreview, 0));

      cm.on('change', () => {
        setDirty(true);
        requestPreviewUpdate();
      });

      // Button handlers
      $('#btnSave').addEventListener('click', () => saveCurrentFile());
      $('#btnToggleLeft').addEventListener('click', toggleLeftSidebar);
      $('#btnToggleRight').addEventListener('click', toggleRightSidebar);
      $('#btnToggleEditor').addEventListener('click', toggleEditor);
      $('#btnTogglePreview').addEventListener('click', togglePreview);
      $('#btnNewFile').addEventListener('click', () => createFile());
      $('#btnNewFolder').addEventListener('click', () => createFolder());
      $('#btnExportWorkspace').addEventListener('click', exportWorkspace);
      
      $('#btnImportWorkspace').addEventListener('click', () => {
        $('#workspaceInput').value = '';
        $('#workspaceInput').click();
      });
      
      $('#workspaceInput').addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) importWorkspace(file);
      });

      $('#btnClearWorkspace').addEventListener('click', () => {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ•´ä¸ªå·¥ä½œåŒºå—ï¼Ÿæ‰€æœ‰æ–‡ä»¶å°†è¢«åˆ é™¤ï¼')) return;
        workspace = { files: {}, activeFileId: null, expandedFolders: [] };
        const defaultId = generateId();
        workspace.files[defaultId] = {
          name: 'æœªå‘½å.md',
          content: '',
          parentId: null,
          type: 'file'
        };
        workspace.activeFileId = defaultId;
        saveWorkspace();
        renderFileTree();
        loadFile(defaultId);
        toast('å·¥ä½œåŒºå·²æ¸…ç©º');
      });

      // Export/Import single file
      function exportMd() {
        const md = cm.getValue();
        const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const fileName = workspace.activeFileId && workspace.files[workspace.activeFileId]
          ? workspace.files[workspace.activeFileId].name.replace(/\.[^.]+$/, '')
          : 'slides';
        a.href = url;
        a.download = `${fileName}.md`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toast('å·²å¯¼å‡º');
      }

      function importFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          const text = String(reader.result || '');
          const id = generateId();
          workspace.files[id] = {
            name: file.name,
            content: text,
            parentId: null,
            type: 'file'
          };
          saveWorkspace();
          renderFileTree();
          loadFile(id);
          toast(`å·²å¯¼å…¥ï¼š${file.name}`);
        };
        reader.readAsText(file, 'utf-8');
      }

      $('#btnExport').addEventListener('click', exportMd);
      
      $('#btnImport').addEventListener('click', () => {
        $('#fileInput').value = '';
        $('#fileInput').click();
      });
      
      $('#fileInput').addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) importFile(file);
      });

      // Fullscreen
      async function toggleFullscreen() {
        const el = $('#previewWrap');
        try {
          if (!document.fullscreenElement) {
            await el.requestFullscreen();
          } else {
            await document.exitFullscreen();
          }
        } catch (_) {
          toast('å…¨å±å¤±è´¥');
        }
        setTimeout(() => deck && deck.layout(), 150);
      }
      $('#btnFullscreen').addEventListener('click', toggleFullscreen);

      // Help modal
      function openHelp() {
        $('#helpModal').setAttribute('aria-hidden', 'false');
      }
      function closeHelp() {
        $('#helpModal').setAttribute('aria-hidden', 'true');
      }
      $('#btnHelp').addEventListener('click', openHelp);
      $('#helpModal').addEventListener('click', (e) => {
        if (e.target && e.target.dataset && e.target.dataset.close === 'true') closeHelp();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeHelp();
          closeRenameModal();
        }
      });

      // Drag & drop
      const editorPanel = $('#editorPanel');
      editorPanel.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
      });
      editorPanel.addEventListener('drop', (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files && e.dataTransfer.files[0];
        if (file) importFile(file);
      });

      // Warn on leave
      window.addEventListener('beforeunload', (e) => {
        if (!dirty) return;
        if (settings.autoSave) return;
        e.preventDefault();
        e.returnValue = '';
      });

      // Resize
      window.addEventListener('resize', debounce(() => {
        if (deck) deck.layout();
        if (cm) cm.refresh();
      }, 120));

      $('#previewWrap').addEventListener('pointerdown', () => {
        $('#previewWrap').focus?.();
      });

      // Initial autosave
      if (settings.autoSave) {
        saveCurrentFile({ silent: true });
      }
    })();
  </script>
</body>
</html>