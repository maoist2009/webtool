<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Reveal.js åœ¨çº¿ Markdown ç¼–è¾‘å™¨</title>

  <script src="https://gcore.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <!-- Reveal.js -->
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/black.css" id="revealTheme">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/monokai.css">

  <!-- CodeMirror -->
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.min.css">

  <style>
    html, body { height: 100%; overflow: hidden; }
    body { margin: 0; overscroll-behavior: none; }

    /* å…³é”®ä¿®å¤ï¼šé™åˆ¶ CodeMirror å®½åº¦é˜²æ­¢æº¢å‡º */
    .CodeMirror { height: 100%; font-size: 14px; line-height: 1.5; }
    #editor { overflow: hidden; }
    #editor .CodeMirror { max-width: 100%; }
    .CodeMirror-scroll { overflow-x: auto !important; }
    .CodeMirror pre { word-break: break-all; }

    /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨å¤„ç†è§¦æ‘¸æ»šåŠ¨ */
    .reveal, .reveal .slides, #previewWrap { touch-action: none !important; }

    #previewWrap { position: relative; }
    #previewWrap .reveal { height: 100%; width: 100%; }

    .btn {
      display: inline-flex; align-items: center; gap: .5rem;
      padding: .5rem .75rem; border-radius: .75rem;
      background: color-mix(in oklab, rgb(30 41 59) 85%, transparent);
      border: 1px solid rgb(51 65 85); color: rgb(226 232 240);
      font-size: 0.875rem; user-select: none; transition: all 0.2s; cursor: pointer;
    }
    .btn:hover { background: rgb(51 65 85); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: rgb(37 99 235); border-color: rgb(30 64 175); }
    .btn.primary:hover { background: rgb(29 78 216); }
    .btn.danger { background: rgb(185 28 28); border-color: rgb(127 29 29); }
    .btn.danger:hover { background: rgb(153 27 27); }
    .btn.icon-only { padding: .5rem; justify-content: center; }
    .btn.active { background: rgb(37 99 235); border-color: rgb(30 64 175); color: white; }
    .btn.sm { padding: .3rem .5rem; font-size: 0.75rem; }

    .chip {
      border: 1px solid rgb(51 65 85); background: rgb(15 23 42);
      color: rgb(148 163 184); border-radius: 9999px;
      padding: 0.25rem 0.6rem; font-size: 0.75rem;
      display: inline-flex; align-items: center; gap: .35rem; white-space: nowrap;
    }

    #toast {
      position: fixed; left: 50%; top: 60px; transform: translateX(-50%);
      z-index: 9999; display: none;
      background: rgba(2, 6, 23, 0.95); border: 1px solid rgb(51 65 85);
      color: rgb(226 232 240); padding: 10px 16px; border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.4); font-size: 0.875rem;
    }

    /* Modal */
    #helpModal[aria-hidden="true"] { display: none; }
    #renameModal[aria-hidden="true"] { display: none; }

    /* Sidebar - ä¿®å¤ç§»åŠ¨ç«¯æº¢å‡º */
    .sidebar { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; flex-shrink: 0; }
    .sidebar.collapsed { width: 0 !important; min-width: 0 !important; opacity: 0; pointer-events: none; border: none !important; }

    /* ä¸»å†…å®¹åŒºåŸŸ - é˜²æ­¢æº¢å‡º */
    main { overflow: hidden; }
    #mainContent { overflow: hidden; min-width: 0; }

    /* File tree */
    .file-tree-item {
      display: flex; align-items: center; gap: 6px; padding: 6px 8px;
      border-radius: 6px; cursor: pointer; font-size: 13px; transition: background 0.15s;
    }
    .file-tree-item:hover { background: rgb(30 41 59); }
    .file-tree-item.active { background: rgb(37 99 235); color: white; }
    .file-tree-item.selected { background: rgb(51 65 85); outline: 2px solid rgb(59 130 246); }
    .file-tree-item.folder { font-weight: 500; }
    .file-tree-item .icon { width: 16px; text-align: center; flex-shrink: 0; }
    .file-tree-item .name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .file-tree-item .actions { display: none; gap: 2px; }
    .file-tree-item:hover .actions { display: flex; }
    .file-tree-item .actions button { background: transparent; border: none; color: rgb(148 163 184); cursor: pointer; padding: 2px 4px; border-radius: 4px; font-size: 11px; }
    .file-tree-item .actions button:hover { background: rgb(51 65 85); color: white; }
    .folder-children { margin-left: 14px; border-left: 1px solid rgb(51 65 85); padding-left: 6px; }
    .folder-children.collapsed { display: none; }

    /* Settings */
    .setting-group { margin-bottom: 12px; }
    .setting-group label { display: block; font-size: 12px; color: rgb(148 163 184); margin-bottom: 4px; }
    .setting-group select, .setting-group input[type="text"], .setting-group input[type="number"] {
      width: 100%; padding: 6px 10px; border-radius: 6px; border: 1px solid rgb(51 65 85);
      background: rgb(15 23 42); color: rgb(226 232 240); font-size: 13px;
    }
    .setting-group input[type="checkbox"] { accent-color: rgb(37 99 235); }

    /* Context menu */
    .context-menu {
      position: fixed; background: rgb(15 23 42); border: 1px solid rgb(51 65 85);
      border-radius: 8px; padding: 4px; z-index: 100; min-width: 140px; box-shadow: 0 8px 24px rgba(0,0,0,.4);
    }
    .context-menu-item { padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
    .context-menu-item:hover { background: rgb(30 41 59); }
    .context-menu-item.danger { color: rgb(248 113 113); }

    .section-header { font-size: 11px; font-weight: 600; color: rgb(100 116 139); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgb(51 65 85); }
    .toggle-btn.active { background: rgb(37 99 235); border-color: rgb(30 64 175); }
    .divider { width: 1px; height: 20px; background: rgb(51 65 85); margin: 0 4px; }
    .panel.hidden-panel { flex: 0 0 0 !important; width: 0 !important; min-width: 0 !important; border: none !important; opacity: 0; pointer-events: none; overflow: hidden; }

    /* ç¼–è¾‘å™¨å’Œé¢„è§ˆé¢æ¿ - é˜²æ­¢æº¢å‡º */
    .panel { min-width: 0; overflow: hidden; }

    /* Annotation Canvas */
    #annotationCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; touch-action: none; display: none; pointer-events: none; }
    #annotationCanvas.fullscreen-active { display: block; }
    #annotationCanvas.drawing-mode { pointer-events: auto; }

    /* Annotation Toolbar */
    #annotationToolbar { position: absolute; z-index: 200; display: none; background: rgba(15, 23, 42, 0.95); border: 1px solid rgb(51 65 85); border-radius: 12px; padding: 8px; gap: 8px; box-shadow: 0 8px 32px rgba(0,0,0,.6); backdrop-filter: blur(8px); }
    #annotationToolbar.visible { display: flex; }

    /* ç«–å±: å·¦ä¾§å‚ç›´ */
    @media (orientation: portrait) {
      #annotationToolbar { left: 10px; top: 50%; transform: translateY(-50%); flex-direction: column; align-items: center; }
      .anno-popup { left: 100%; top: 50%; transform: translateY(-50%); margin-left: 10px; }
      .anno-divider { width: 24px; height: 1px; margin: 4px 0; }
    }
    /* æ¨ªå±: åº•éƒ¨æ°´å¹³ */
    @media (orientation: landscape) {
      #annotationToolbar { bottom: 20px; left: 50%; transform: translateX(-50%); flex-direction: row; align-items: center; }
      .anno-popup { bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 10px; }
      .anno-divider { width: 1px; height: 24px; margin: 0 4px; }
    }

    .anno-btn { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: transparent; color: rgb(148 163 184); border: 1px solid transparent; cursor: pointer; flex-shrink: 0; }
    .anno-btn:hover { background: rgb(30 41 59); color: white; }
    .anno-btn.active { background: rgb(37 99 235); color: white; border-color: rgb(30 64 175); }
    .anno-btn.danger:hover { background: rgb(185 28 28); color: white; }
    .anno-divider { background: rgb(51 65 85); }

    .anno-popup { position: absolute; background: rgba(15, 23, 42, 0.95); border: 1px solid rgb(51 65 85); border-radius: 12px; padding: 8px; display: none; gap: 8px; flex-wrap: wrap; width: max-content; max-width: 160px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .anno-popup.active { display: grid; grid-template-columns: repeat(5, 1fr); }
    .color-btn { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgb(51 65 85); cursor: pointer; }
    .color-btn.active { border-color: white; box-shadow: 0 0 0 2px rgb(37 99 235); }
    .width-btn { grid-column: span 5; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 4px; padding-top: 4px; border-top: 1px solid rgb(51 65 85); }
    .stroke-dot { background: rgb(148 163 184); border-radius: 50%; cursor: pointer; }
    .stroke-dot:hover { background: white; }
    .stroke-dot.active { background: rgb(37 99 235); box-shadow: 0 0 0 2px rgba(37 99 235, 0.3); }

    #fsControls { position: absolute; top: 10px; right: 10px; z-index: 200; display: none; gap: 8px; }
    #fsControls.visible { display: flex; }

    /* å³ä¾§è¾¹æ åœ¨ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 640px) {
      #rightSidebar { width: 100% !important; min-width: 0 !important; position: absolute; right: 0; top: 0; bottom: 0; z-index: 50; }
      #rightSidebar.collapsed { transform: translateX(100%); }
      #leftSidebar { width: 100% !important; min-width: 0 !important; position: absolute; left: 0; top: 0; bottom: 0; z-index: 50; }
      #leftSidebar.collapsed { transform: translateX(-100%); }
    }
  </style>
</head>

<body class="h-screen bg-slate-950 text-slate-100">
  <div class="h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header class="sticky top-0 z-40 border-b border-slate-800 bg-slate-900/95 backdrop-blur flex-shrink-0">
      <div class="px-2 py-2 flex items-center gap-1.5">
        <button id="btnToggleLeft" class="btn icon-only toggle-btn" title="åˆ‡æ¢æ–‡ä»¶æ  (Ctrl+B)">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
        </button>
        <div class="divider"></div>
        <div class="flex items-center gap-2 px-2">
          <div class="w-2 h-2 rounded-full bg-blue-500"></div>
          <span class="font-semibold text-sm hidden sm:inline">Reveal.js ç¼–è¾‘å™¨</span>
          <span class="font-semibold text-sm sm:hidden">ç¼–è¾‘å™¨</span>
        </div>
        <div class="divider"></div>
        <button id="btnToggleEditor" class="btn sm toggle-btn active" title="æ˜¾ç¤º/éšè—ç¼–è¾‘å™¨">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          <span class="hidden sm:inline">ç¼–è¾‘</span>
        </button>
        <button id="btnTogglePreview" class="btn sm toggle-btn active" title="æ˜¾ç¤º/éšè—é¢„è§ˆ">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          <span class="hidden sm:inline">é¢„è§ˆ</span>
        </button>
        <div class="flex-1"></div>
        <div id="status" class="chip text-xs" aria-live="polite">å·²ä¿å­˜</div>
        <div class="divider"></div>
        <button id="btnToggleRight" class="btn icon-only toggle-btn" title="åˆ‡æ¢èœå•æ ">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <input id="fileInput" type="file" accept=".md,.markdown,.txt" class="hidden" />
        <input id="workspaceInput" type="file" accept=".json" class="hidden" />
      </div>
    </header>

    <main class="flex-1 min-h-0 flex relative">
      <!-- Left Sidebar -->
      <aside id="leftSidebar" class="sidebar w-56 min-w-56 border-r border-slate-800 bg-slate-950 flex flex-col">
        <div class="p-2 border-b border-slate-800 flex items-center justify-between">
          <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">å·¥ä½œåŒº</span>
          <div class="flex gap-1">
            <button id="btnNewFile" class="btn sm icon-only" title="æ–°å»ºæ–‡ä»¶ï¼ˆåœ¨é€‰ä¸­ä½ç½®ï¼‰">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
            </button>
            <button id="btnNewFolder" class="btn sm icon-only" title="æ–°å»ºæ–‡ä»¶å¤¹ï¼ˆåœ¨é€‰ä¸­ä½ç½®ï¼‰">
              <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/><line x1="12" y1="11" x2="12" y2="17"/><line x1="9" y1="14" x2="15" y2="14"/></svg>
            </button>
          </div>
        </div>
        <div id="fileTree" class="flex-1 overflow-auto p-2"></div>
      </aside>

      <!-- Main Content -->
      <div id="mainContent" class="flex-1 min-h-0 flex flex-col-reverse md:flex-row overflow-hidden">
        <!-- Preview Panel -->
        <section id="previewPanel" class="panel flex-1 min-h-0 flex flex-col order-first md:order-last overflow-hidden">
          <div class="px-3 py-1.5 border-b md:border-b border-t md:border-t-0 border-slate-800 bg-slate-900/50 flex items-center gap-2 flex-shrink-0">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-slate-500"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            <span class="text-xs text-slate-300 font-medium">é¢„è§ˆ</span>
            <span class="text-xs text-slate-500 hidden sm:inline">æ–¹å‘é”®ç¿»é¡µ</span>
            <div class="ml-auto flex items-center gap-2">
              <label class="flex items-center gap-1 text-xs text-slate-400 cursor-pointer" title="ç¼–è¾‘æ—¶è‡ªåŠ¨åŒæ­¥å¹»ç¯ç‰‡ä½ç½®">
                <input type="checkbox" id="settingSyncSlide" class="accent-blue-500" />
                <span class="hidden sm:inline">åŒæ­¥</span>
              </label>
              <button id="btnFullscreen" class="btn sm" title="å…¨å±æ”¾æ˜ ">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                <span>æ”¾æ˜ </span>
              </button>
            </div>
          </div>
          <div id="previewWrap" class="flex-1 min-h-0 overflow-hidden bg-black relative">
            <div id="revealRoot" class="reveal">
              <div id="slides" class="slides"></div>
            </div>
            <canvas id="annotationCanvas"></canvas>
            <div id="fsControls">
              <button id="btnToggleAnno" class="btn sm" title="æ‰¹æ³¨å·¥å…·">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg>
                <span class="hidden sm:inline ml-1">æ‰¹æ³¨</span>
              </button>
              <button id="btnExitFs" class="btn sm" title="é€€å‡ºå…¨å±">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
              </button>
            </div>
            <div id="annotationToolbar">
              <!-- æŒ‡é’ˆ -->
              <button class="anno-btn active" data-tool="pointer" title="æŒ‡é’ˆï¼ˆæ“ä½œå¹»ç¯ç‰‡ï¼‰"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg></button>
              <!-- ç”»ç¬” -->
              <button class="anno-btn" data-tool="pen" title="ç”»ç¬”"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/></svg></button>
              <!-- è§å…‰ç¬” -->
              <button class="anno-btn" data-tool="highlighter" title="è§å…‰ç¬”"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l-6 6v3h9l3-3"/><path d="M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg></button>
              <!-- ç›´çº¿ -->
              <button class="anno-btn" data-tool="line" title="ç›´çº¿"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"/></svg></button>
              <!-- çŸ©å½¢ -->
              <button class="anno-btn" data-tool="rect" title="çŸ©å½¢"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/></svg></button>
              <!-- æ¤­åœ† -->
              <button class="anno-btn" data-tool="ellipse" title="æ¤­åœ†"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="9" ry="6"/></svg></button>
              <!-- ç®­å¤´ -->
              <button class="anno-btn" data-tool="arrow" title="ç®­å¤´"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></button>
              <!-- æ©¡çš®æ“¦ -->
              <button class="anno-btn" data-tool="eraser" title="æ©¡çš®æ“¦"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 20H7L3 16c-.6-.6-.6-1.5 0-2.1L13.1 3.8c.6-.6 1.5-.6 2.1 0L21 9.5c.6.6.6 1.5 0 2.1L12 20"/></svg></button>
              <div class="anno-divider"></div>
              <div class="relative">
                <button class="anno-btn" id="btnAnnoStyle" title="æ ·å¼è®¾ç½®"><div id="currentStylePreview" style="width: 16px; height: 16px; border-radius: 50%; background: #ef4444; border: 2px solid currentColor;"></div></button>
                <div id="stylePopup" class="anno-popup">
                  <div class="color-btn active" data-color="#ef4444" style="background: #ef4444"></div>
                  <div class="color-btn" data-color="#3b82f6" style="background: #3b82f6"></div>
                  <div class="color-btn" data-color="#22c55e" style="background: #22c55e"></div>
                  <div class="color-btn" data-color="#eab308" style="background: #eab308"></div>
                  <div class="color-btn" data-color="#ffffff" style="background: #ffffff"></div>
                  <div class="color-btn" data-color="#f97316" style="background: #f97316"></div>
                  <div class="color-btn" data-color="#a855f7" style="background: #a855f7"></div>
                  <div class="color-btn" data-color="#06b6d4" style="background: #06b6d4"></div>
                  <div class="color-btn" data-color="#ec4899" style="background: #ec4899"></div>
                  <div class="color-btn" data-color="#000000" style="background: #000000; border-color: #666;"></div>
                  <div class="width-btn">
                    <div class="stroke-dot" data-width="2" style="width: 6px; height: 6px;"></div>
                    <div class="stroke-dot active" data-width="4" style="width: 10px; height: 10px;"></div>
                    <div class="stroke-dot" data-width="8" style="width: 14px; height: 14px;"></div>
                    <div class="stroke-dot" data-width="12" style="width: 18px; height: 18px;"></div>
                  </div>
                </div>
              </div>
              <div class="anno-divider"></div>
              <button class="anno-btn" id="btnUndo" title="æ’¤é”€"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg></button>
              <button class="anno-btn danger" id="btnClearAnno" title="æ¸…é™¤æ‰€æœ‰"><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
              <button class="anno-btn" id="btnCloseToolbar" title="éšè—å·¥å…·æ "><svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
          </div>
        </section>

        <!-- Editor Panel -->
        <section id="editorPanel" class="panel flex-1 min-h-0 flex flex-col order-last md:order-first md:border-r border-slate-800 overflow-hidden">
          <div class="px-3 py-1.5 border-b border-slate-800 bg-slate-900/50 flex items-center gap-2 flex-shrink-0">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-slate-500"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            <span id="currentFileName" class="text-xs text-slate-300 font-medium truncate"></span>
            <div class="ml-auto text-xs text-slate-500">Ctrl+S ä¿å­˜</div>
          </div>
          <div class="flex-1 min-h-0 overflow-hidden" id="editor"></div>
        </section>
      </div>

      <!-- Right Sidebar -->
      <aside id="rightSidebar" class="sidebar w-64 min-w-64 border-l border-slate-800 bg-slate-950 flex flex-col">
        <div class="flex-1 overflow-auto">
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">æ–‡ä»¶æ“ä½œ</div>
            <div class="grid grid-cols-2 gap-1.5">
              <button id="btnSave" class="btn primary w-full" title="Ctrl+S">ä¿å­˜</button>
              <button id="btnExport" class="btn w-full" title="å¯¼å‡ºå½“å‰æ–‡ä»¶">å¯¼å‡º</button>
              <button id="btnImport" class="btn w-full" title="å¯¼å…¥ .md æ–‡ä»¶">å¯¼å…¥</button>
              <button id="btnExportPDF" class="btn w-full" title="å¯¼å‡ºä¸ºPDFï¼ˆæ‰“å°ï¼‰">å¯¼å‡ºPDF</button>
            </div>
            <button id="btnHelp" class="btn w-full mt-1.5" title="ä½¿ç”¨è¯´æ˜">å¸®åŠ©</button>
          </div>
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">å·¥ä½œåŒº</div>
            <div class="grid grid-cols-2 gap-1.5">
              <button id="btnExportWorkspace" class="btn w-full text-xs" title="å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶">å¯¼å‡ºå…¨éƒ¨</button>
              <button id="btnImportWorkspace" class="btn w-full text-xs" title="å¯¼å…¥å·¥ä½œåŒº">å¯¼å…¥å…¨éƒ¨</button>
            </div>
            <button id="btnClearWorkspace" class="btn danger w-full mt-2 text-xs">æ¸…ç©ºå·¥ä½œåŒº</button>
          </div>
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">ç¼–è¾‘å™¨è®¾ç½®</div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingAutoSave" checked /><span>è‡ªåŠ¨ä¿å­˜</span></label></div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingLineWrap" checked /><span>è‡ªåŠ¨æ¢è¡Œ</span></label></div>
            <div class="setting-group"><label>å­—ä½“å¤§å°</label><select id="settingFontSize"><option value="12">12px</option><option value="14" selected>14px</option><option value="16">16px</option><option value="18">18px</option></select></div>
          </div>
          <div class="p-3 border-b border-slate-800">
            <div class="section-header">æ¼”ç¤ºæ–‡ç¨¿</div>
            <div class="setting-group"><label>ä¸»é¢˜</label><select id="settingTheme"><option value="black">Black</option><option value="white">White</option><option value="league">League</option><option value="beige">Beige</option><option value="sky">Sky</option><option value="night">Night</option><option value="serif">Serif</option><option value="simple">Simple</option><option value="solarized">Solarized</option><option value="moon">Moon</option><option value="dracula">Dracula</option></select></div>
            <div class="setting-group"><label>åˆ‡æ¢æ•ˆæœ</label><select id="settingTransition"><option value="none">æ— </option><option value="fade">æ·¡å…¥æ·¡å‡º</option><option value="slide" selected>æ»‘åŠ¨</option><option value="convex">å‡¸å‡º</option><option value="concave">å‡¹å…¥</option><option value="zoom">ç¼©æ”¾</option></select></div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingControls" checked /><span>æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®</span></label></div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingProgress" checked /><span>æ˜¾ç¤ºè¿›åº¦æ¡</span></label></div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingSlideNumber" checked /><span>æ˜¾ç¤ºé¡µç </span></label></div>
            <div class="setting-group"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="settingOverflowWarn" checked /><span>å†…å®¹è¶…å‡ºæé†’</span></label></div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <div id="toast"></div>
  <div id="contextMenu" class="context-menu" style="display: none;"></div>

  <!-- Help Modal -->
  <div id="helpModal" aria-hidden="true" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70" id="helpModalBg"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-xl border border-slate-700 bg-slate-950 shadow-2xl">
        <div class="p-4 border-b border-slate-800 flex items-center gap-2">
          <div class="font-semibold">ä½¿ç”¨è¯´æ˜</div>
          <button class="ml-auto btn sm" id="btnCloseHelp" type="button">å…³é—­</button>
        </div>
        <div class="p-4 space-y-3 text-sm text-slate-200 max-h-[70vh] overflow-auto">
          <div class="text-slate-300">è¿™æ˜¯ä¸€ä¸ªåŸºäº <span class="font-semibold text-blue-400">Markdown â†’ Reveal.js</span> çš„åœ¨çº¿å¹»ç¯ç‰‡ç¼–è¾‘å™¨ã€‚</div>
          <div class="section-header mt-4">å¹»ç¯ç‰‡åˆ†éš”</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li><code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">---</code>ï¼šæ¨ªå‘åˆ†é¡µï¼ˆä¸‹ä¸€å¼ ï¼‰</li>
            <li><code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">--</code>ï¼šçºµå‘åˆ†é¡µï¼ˆä¸‹é’»ï¼‰</li>
          </ul>
          <div class="section-header mt-4">æ‰¹æ³¨ç”»æ¿ï¼ˆæ”¾æ˜ æ¨¡å¼ï¼‰</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li><strong>æŒ‡é’ˆæ¨¡å¼</strong>ï¼šé»˜è®¤æ¨¡å¼ï¼Œå¯æ­£å¸¸æ“ä½œå¹»ç¯ç‰‡ç¿»é¡µ</li>
            <li><strong>ç”»ç¬”</strong>ï¼šè‡ªç”±ç»˜åˆ¶ï¼Œæ”¯æŒå¤šç§é¢œè‰²å’Œç²—ç»†</li>
            <li><strong>ç®­å¤´</strong>ï¼šç»˜åˆ¶ç®­å¤´æŒ‡ç¤º</li>
            <li><strong>æ©¡çš®æ“¦</strong>ï¼šæ“¦é™¤æ‰¹æ³¨å†…å®¹</li>
            <li>ç‚¹å‡»ã€Œæ‰¹æ³¨ã€æŒ‰é’®å¯æ˜¾ç¤º/éšè—å·¥å…·æ </li>
          </ul>
          <div class="section-header mt-4">åŒæ­¥åŠŸèƒ½</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>å‹¾é€‰é¢„è§ˆåŒºçš„ã€ŒåŒæ­¥ã€å¤é€‰æ¡†å¯åœ¨ç¼–è¾‘æ—¶è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”å¹»ç¯ç‰‡</li>
          </ul>
          <div class="section-header mt-4">æ¨¡æ¿åŠŸèƒ½</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>åœ¨ä»»æ„æ–‡ä»¶å¤¹ä¸­åˆ›å»ºåä¸º <code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">_template.md</code> çš„æ–‡ä»¶</li>
            <li>æ–°å»ºæ–‡ä»¶æ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥æ¨¡æ¿ä½œä¸ºåˆå§‹å†…å®¹</li>
            <li>æ¨¡æ¿æŸ¥æ‰¾é¡ºåºï¼šå½“å‰æ–‡ä»¶å¤¹ â†’ çˆ¶æ–‡ä»¶å¤¹ â†’ ... â†’ æ ¹ç›®å½•</li>
            <li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ¨¡æ¿ï¼Œæ–°æ–‡ä»¶å†…å®¹ä¸ºç©º</li>
          </ul>
          <div class="section-header mt-4">å†…å®¹è¶…å‡ºæé†’</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li>å½“å•é¡µå†…å®¹è¿‡å¤šæ—¶ï¼ˆè¡Œæ•° &gt; 25ã€å­—ç¬¦æ•° &gt; 1200ã€å¤§å‹ä»£ç å—ã€è¿‡å¤šåˆ—è¡¨é¡¹ï¼‰ï¼Œä¼šè‡ªåŠ¨æé†’</li>
            <li>å¯åœ¨å³ä¾§è®¾ç½®ä¸­å…³é—­æ­¤åŠŸèƒ½</li>
            <li>å»ºè®®å°†å†…å®¹è¾ƒå¤šçš„é¡µé¢æ‹†åˆ†ä¸ºå¤šä¸ªå­é¡µé¢ï¼ˆä½¿ç”¨ <code class="bg-slate-800 px-1.5 py-0.5 rounded text-blue-300">--</code> åˆ†éš”ï¼‰</li>
          </ul>
          <div class="section-header mt-4">å…³äºæ­¤å·¥å…·</div>
          <ul class="list-disc pl-5 space-y-1 text-slate-300">
            <li><strong>ä½œè€…</strong>ï¼šç”± <a href="https://github.com/maoist2009/" class="text-blue-400 hover:underline">maoist2009</a> ä½¿ç”¨ <a href="https://lmarena.ai/" class="text-blue-400 hover:underline">Lmarena</a> ä¸Šçš„ claude-opus-4-5-20251101-thinking-32k åˆ¶ä½œ</li>
            <li><strong>å¼€æºåè®®</strong>ï¼šAGPL-v3-or-later</li>
            <li><strong>Workers, Unite!</strong></li>
          </ul>
          <div class="mt-4 p-3 bg-slate-800/50 rounded-lg text-xs text-slate-400">
            <p>ğŸ’¡ æç¤ºï¼šæ‚¨å¯ä»¥éšæ—¶ç‚¹å‡»å³ä¾§èœå•æ ä¸­çš„ã€Œå¸®åŠ©ã€æŒ‰é’®å†æ¬¡æ‰“å¼€æ­¤è¯´æ˜ã€‚</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="renameModal" aria-hidden="true" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70" id="renameModalBg"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-sm rounded-xl border border-slate-700 bg-slate-950 shadow-2xl">
        <div class="p-4 border-b border-slate-800"><div class="font-semibold" id="renameModalTitle">é‡å‘½å</div></div>
        <div class="p-4"><input type="text" id="renameInput" class="w-full px-3 py-2 rounded-lg border border-slate-700 bg-slate-900 text-white focus:outline-none focus:border-blue-500" /></div>
        <div class="p-4 border-t border-slate-800 flex justify-end gap-2">
          <button class="btn" id="btnCancelRename">å–æ¶ˆ</button>
          <button id="renameConfirm" class="btn primary">ç¡®å®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dependencies -->
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/codemirror@5.65.16/mode/javascript/javascript.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/reveal.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/notes/notes.js"></script>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/highlight.js"></script>

  <script>
    (() => {
      const WORKSPACE_KEY = 'reveal_md_workspace_v3';
      const SETTINGS_KEY = 'reveal_md_settings_v3';
      const UI_STATE_KEY = 'reveal_md_ui_state_v2';

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => [...document.querySelectorAll(sel)];
      const toastEl = $('#toast');

      function toast(msg) { toastEl.textContent = msg; toastEl.style.display = 'block'; clearTimeout(toastEl.__t); toastEl.__t = setTimeout(() => (toastEl.style.display = 'none'), 2000); }
      function debounce(fn, wait) { let t = null; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; }
      function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2, 9); }

      const defaultMd = `# Reveal.js åœ¨çº¿ç¼–è¾‘å™¨\n\næ¬¢è¿ä½¿ç”¨ï¼\n\n---\n\n## æ ¸å¿ƒåŠŸèƒ½\n\n- ğŸ“ å·¦ä¾§ï¼šæ–‡ä»¶å¤¹ç»“æ„ç®¡ç†\n- âœï¸ ä¸­é—´ï¼šMarkdown ç¼–è¾‘å™¨\n- âš™ï¸ å³ä¾§ï¼šæ“ä½œä¸è®¾ç½®é¢æ¿\n\n---\n\n## åˆ†éš”ç¬¦è¯­æ³•\n\n- \`---\`ï¼šæ¨ªå‘åˆ†é¡µ\n- \`--\`ï¼šçºµå‘åˆ†é¡µ\n\n--\n\n### è¿™æ˜¯çºµå‘å­é¡µé¢\n\n\`\`\`javascript\nconsole.log('Hello Reveal.js!')\n\`\`\`\n\n---\n\n## å¿«æ·é”®\n\n| åŠŸèƒ½ | å¿«æ·é”® |\n|------|--------|\n| ä¿å­˜ | Ctrl+S |\n| å…¨å±æ”¾æ˜  | Alt+Enter |\n`;

      let workspace = { files: {}, activeFileId: null, selectedItemId: null, expandedFolders: [] };
      let settings = { autoSave: true, lineWrap: true, fontSize: 14, theme: 'black', transition: 'slide', controls: true, progress: true, slideNumber: true, syncSlide: false, overflowWarn: true, firstVisit: true };
      let uiState = { leftSidebarOpen: true, rightSidebarOpen: true, editorVisible: true, previewVisible: true };

      try { const s = JSON.parse(localStorage.getItem(WORKSPACE_KEY)); if (s && s.files) workspace = { ...workspace, ...s }; } catch (_) {}
      try { const s = JSON.parse(localStorage.getItem(SETTINGS_KEY)); if (s) settings = { ...settings, ...s }; } catch (_) {}
      try { const s = JSON.parse(localStorage.getItem(UI_STATE_KEY)); if (s) uiState = { ...uiState, ...s }; } catch (_) {}

      if (Object.keys(workspace.files).length === 0) {
        const id = generateId();
        workspace.files[id] = { name: 'æ¬¢è¿.md', content: defaultMd, parentId: null, type: 'file' };
        workspace.activeFileId = id;
      }

      marked.setOptions({ gfm: true, breaks: false, headerIds: false, mangle: false });

      const statusEl = $('#status');
      let dirty = false, deck = null, cm = null, contextMenuTarget = null, isFullscreen = false;

      function setDirty(v) { dirty = v; renderStatus(); }
      function renderStatus(extra) { const t = dirty ? 'æœªä¿å­˜' : 'å·²ä¿å­˜'; statusEl.textContent = extra ? `${t} Â· ${extra}` : t; statusEl.style.borderColor = dirty ? 'rgb(234 179 8)' : 'rgb(34 197 94)'; statusEl.style.color = dirty ? 'rgb(250 204 21)' : 'rgb(134 239 172)'; }
      function nowTime() { return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
      function saveWorkspace() { localStorage.setItem(WORKSPACE_KEY, JSON.stringify(workspace)); localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); localStorage.setItem(UI_STATE_KEY, JSON.stringify(uiState)); }
      function saveCurrentFile({ silent = false } = {}) { if (!workspace.activeFileId || !workspace.files[workspace.activeFileId]) return; workspace.files[workspace.activeFileId].content = cm.getValue(); saveWorkspace(); setDirty(false); renderStatus(nowTime()); if (!silent) toast('å·²ä¿å­˜'); }
      function loadFile(fileId) { if (!workspace.files[fileId] || workspace.files[fileId].type !== 'file') return; if (workspace.activeFileId && workspace.files[workspace.activeFileId]) workspace.files[workspace.activeFileId].content = cm.getValue(); workspace.activeFileId = fileId; workspace.selectedItemId = fileId; const file = workspace.files[fileId]; cm.setValue(file.content || ''); $('#currentFileName').textContent = file.name; setDirty(false); saveWorkspace(); renderFileTree(); requestPreviewUpdate(); }
      
      // è·å–é€‰ä¸­é¡¹ç›®çš„çˆ¶çº§IDï¼ˆç”¨äºç¡®å®šæ–°å»ºæ–‡ä»¶/æ–‡ä»¶å¤¹çš„ä½ç½®ï¼‰
      function getTargetParentId() {
        if (!workspace.selectedItemId) return null;
        const selected = workspace.files[workspace.selectedItemId];
        if (!selected) return null;
        // å¦‚æœé€‰ä¸­çš„æ˜¯æ–‡ä»¶å¤¹ï¼Œåˆ™åœ¨è¯¥æ–‡ä»¶å¤¹å†…åˆ›å»º
        if (selected.type === 'folder') return workspace.selectedItemId;
        // å¦‚æœé€‰ä¸­çš„æ˜¯æ–‡ä»¶ï¼Œåˆ™åœ¨åŒçº§ç›®å½•åˆ›å»º
        return selected.parentId;
      }
      
      // æŸ¥æ‰¾æ¨¡æ¿æ–‡ä»¶ï¼šä»æŒ‡å®šæ–‡ä»¶å¤¹å‘ä¸ŠæŸ¥æ‰¾ _template.md
      function findTemplate(parentId) {
        let currentParentId = parentId;
        while (true) {
          // åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾ _template.md
          const templateFile = Object.entries(workspace.files).find(([_, f]) => 
            f.type === 'file' && f.name === '_template.md' && f.parentId === currentParentId
          );
          if (templateFile) {
            return templateFile[1].content || '';
          }
          // å¦‚æœå·²ç»æ˜¯æ ¹ç›®å½•ï¼Œåœæ­¢æŸ¥æ‰¾
          if (currentParentId === null) break;
          // å‘ä¸ŠæŸ¥æ‰¾çˆ¶ç›®å½•
          const parentFolder = workspace.files[currentParentId];
          if (!parentFolder) break;
          currentParentId = parentFolder.parentId;
        }
        return ''; // æ²¡æ‰¾åˆ°æ¨¡æ¿ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
      }
      
      function createFile(name, parentId = null) { 
        const id = generateId(); 
        const templateContent = findTemplate(parentId);
        workspace.files[id] = { name: name || 'æœªå‘½å.md', content: templateContent, parentId, type: 'file' }; 
        saveWorkspace(); 
        renderFileTree(); 
        loadFile(id); 
        toast(templateContent ? 'å·²åˆ›å»ºæ–‡ä»¶ï¼ˆä½¿ç”¨æ¨¡æ¿ï¼‰' : 'å·²åˆ›å»ºæ–‡ä»¶'); 
      }
      function createFolder(name, parentId = null) { const id = generateId(); workspace.files[id] = { name: name || 'æ–°æ–‡ä»¶å¤¹', parentId, type: 'folder' }; if (!workspace.expandedFolders.includes(id)) workspace.expandedFolders.push(id); if (parentId && !workspace.expandedFolders.includes(parentId)) workspace.expandedFolders.push(parentId); workspace.selectedItemId = id; saveWorkspace(); renderFileTree(); toast('å·²åˆ›å»ºæ–‡ä»¶å¤¹'); }
      function deleteItem(id) { const item = workspace.files[id]; if (!item) return; if (item.type === 'folder') Object.keys(workspace.files).forEach(fid => { if (workspace.files[fid].parentId === id) deleteItem(fid); }); delete workspace.files[id]; if (workspace.activeFileId === id) { const files = Object.entries(workspace.files).filter(([_, f]) => f.type === 'file'); workspace.activeFileId = files.length > 0 ? files[0][0] : null; if (workspace.activeFileId) loadFile(workspace.activeFileId); else { cm.setValue(''); $('#currentFileName').textContent = ''; } } if (workspace.selectedItemId === id) workspace.selectedItemId = null; saveWorkspace(); renderFileTree(); toast('å·²åˆ é™¤'); }
      function renameItem(id, newName) { if (!workspace.files[id]) return; workspace.files[id].name = newName; saveWorkspace(); renderFileTree(); if (workspace.activeFileId === id) $('#currentFileName').textContent = newName; toast('å·²é‡å‘½å'); }
      function toggleFolder(id) { const idx = workspace.expandedFolders.indexOf(id); if (idx > -1) workspace.expandedFolders.splice(idx, 1); else workspace.expandedFolders.push(id); saveWorkspace(); renderFileTree(); }

      function renderFileTree() { 
        const container = $('#fileTree'); 
        container.innerHTML = ''; 
        function renderItems(parentId) { 
          const items = Object.entries(workspace.files).filter(([_, item]) => item.parentId === parentId).sort((a, b) => { if (a[1].type !== b[1].type) return a[1].type === 'folder' ? -1 : 1; return a[1].name.localeCompare(b[1].name); }); 
          const fragment = document.createDocumentFragment(); 
          items.forEach(([id, item]) => { 
            const div = document.createElement('div'); 
            const isActive = workspace.activeFileId === id;
            const isSelected = workspace.selectedItemId === id;
            div.className = 'file-tree-item' + (item.type === 'folder' ? ' folder' : '') + (isActive ? ' active' : '') + (isSelected && !isActive ? ' selected' : ''); 
            div.dataset.id = id; 
            const isExpanded = workspace.expandedFolders.includes(id); 
            div.innerHTML = `<span class="icon">${item.type === 'folder' ? (isExpanded ? 'ğŸ“‚' : 'ğŸ“') : 'ğŸ“„'}</span><span class="name">${item.name}</span><span class="actions"><button data-action="rename" title="é‡å‘½å">âœï¸</button><button data-action="delete" title="åˆ é™¤">ğŸ—‘ï¸</button></span>`; 
            div.addEventListener('click', (e) => { 
              if (e.target.dataset.action) return; 
              workspace.selectedItemId = id;
              if (item.type === 'folder') {
                toggleFolder(id);
              } else {
                loadFile(id);
              }
              renderFileTree();
            }); 
            div.addEventListener('contextmenu', (e) => { e.preventDefault(); showContextMenu(e, id); }); 
            div.querySelectorAll('[data-action]').forEach(btn => { 
              btn.addEventListener('click', (e) => { 
                e.stopPropagation(); 
                if (btn.dataset.action === 'rename') openRenameModal(id); 
                else if (btn.dataset.action === 'delete') { if (confirm(`ç¡®å®šåˆ é™¤ "${item.name}"ï¼Ÿ`)) deleteItem(id); } 
              }); 
            }); 
            fragment.appendChild(div); 
            if (item.type === 'folder') { 
              const children = document.createElement('div'); 
              children.className = 'folder-children' + (isExpanded ? '' : ' collapsed'); 
              const childItems = renderItems(id); 
              if (childItems.childNodes.length > 0) children.appendChild(childItems); 
              fragment.appendChild(children); 
            } 
          }); 
          return fragment; 
        } 
        container.appendChild(renderItems(null)); 
      }
      function showContextMenu(e, id) { contextMenuTarget = id; workspace.selectedItemId = id; renderFileTree(); const menu = $('#contextMenu'); const item = workspace.files[id]; menu.innerHTML = `${item.type === 'folder' ? `<div class="context-menu-item" data-action="newFile">ğŸ“„ æ–°å»ºæ–‡ä»¶</div><div class="context-menu-item" data-action="newFolder">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</div>` : ''}<div class="context-menu-item" data-action="rename">âœï¸ é‡å‘½å</div><div class="context-menu-item danger" data-action="delete">ğŸ—‘ï¸ åˆ é™¤</div>`; menu.style.display = 'block'; menu.style.left = Math.min(e.clientX, window.innerWidth - 160) + 'px'; menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px'; }
      document.addEventListener('click', () => $('#contextMenu').style.display = 'none');
      $('#contextMenu').addEventListener('click', (e) => { const action = e.target.dataset.action; if (!action || !contextMenuTarget) return; const item = workspace.files[contextMenuTarget]; if (action === 'rename') openRenameModal(contextMenuTarget); else if (action === 'delete') { if (confirm(`ç¡®å®šåˆ é™¤ "${item.name}"ï¼Ÿ`)) deleteItem(contextMenuTarget); } else if (action === 'newFile') createFile('æœªå‘½å.md', contextMenuTarget); else if (action === 'newFolder') createFolder('æ–°æ–‡ä»¶å¤¹', contextMenuTarget); $('#contextMenu').style.display = 'none'; });

      let renameTargetId = null;
      function openRenameModal(id) { renameTargetId = id; const item = workspace.files[id]; $('#renameModalTitle').textContent = item.type === 'folder' ? 'é‡å‘½åæ–‡ä»¶å¤¹' : 'é‡å‘½åæ–‡ä»¶'; $('#renameInput').value = item.name; $('#renameModal').setAttribute('aria-hidden', 'false'); setTimeout(() => $('#renameInput').select(), 50); }
      function closeRenameModal() { $('#renameModal').setAttribute('aria-hidden', 'true'); renameTargetId = null; }
      $('#renameModalBg').addEventListener('click', closeRenameModal);
      $('#btnCancelRename').addEventListener('click', closeRenameModal);
      $('#renameConfirm').addEventListener('click', () => { const newName = $('#renameInput').value.trim(); if (newName && renameTargetId) renameItem(renameTargetId, newName); closeRenameModal(); });
      $('#renameInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('#renameConfirm').click(); else if (e.key === 'Escape') closeRenameModal(); });

      function exportWorkspace() { const data = { version: 3, exportDate: new Date().toISOString(), workspace, settings }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `reveal-workspace-${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('å·²å¯¼å‡ºå·¥ä½œåŒº'); }
      function importWorkspace(file) { const reader = new FileReader(); reader.onload = () => { try { const data = JSON.parse(reader.result); if (!data.workspace || !data.workspace.files) throw new Error('Invalid'); workspace.activeFileId = null; workspace = data.workspace; if (data.settings) { settings = { ...settings, ...data.settings }; applySettings(); } saveWorkspace(); renderFileTree(); let targetFileId = workspace.activeFileId; if (!targetFileId || !workspace.files[targetFileId]) { const files = Object.entries(workspace.files).filter(([_, f]) => f.type === 'file'); targetFileId = files.length > 0 ? files[0][0] : null; } if (targetFileId && workspace.files[targetFileId]) { workspace.activeFileId = targetFileId; const file = workspace.files[targetFileId]; cm.setValue(file.content || ''); $('#currentFileName').textContent = file.name; setDirty(false); saveWorkspace(); renderFileTree(); requestPreviewUpdate(); } else { cm.setValue(''); $('#currentFileName').textContent = ''; } toast('å·²å¯¼å…¥å·¥ä½œåŒº'); } catch (e) { toast('å¯¼å…¥å¤±è´¥'); } }; reader.readAsText(file); }

      function updateToggleButtons() { $('#btnToggleLeft').classList.toggle('active', uiState.leftSidebarOpen); $('#btnToggleRight').classList.toggle('active', uiState.rightSidebarOpen); $('#btnToggleEditor').classList.toggle('active', uiState.editorVisible); $('#btnTogglePreview').classList.toggle('active', uiState.previewVisible); }
      function toggleLeftSidebar() { uiState.leftSidebarOpen = !uiState.leftSidebarOpen; $('#leftSidebar').classList.toggle('collapsed', !uiState.leftSidebarOpen); updateToggleButtons(); saveWorkspace(); setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250); }
      function toggleRightSidebar() { uiState.rightSidebarOpen = !uiState.rightSidebarOpen; $('#rightSidebar').classList.toggle('collapsed', !uiState.rightSidebarOpen); updateToggleButtons(); saveWorkspace(); setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250); }
      function toggleEditor() { if (uiState.editorVisible && !uiState.previewVisible) return toast('è‡³å°‘éœ€è¦æ˜¾ç¤ºä¸€ä¸ªé¢æ¿'); uiState.editorVisible = !uiState.editorVisible; $('#editorPanel').classList.toggle('hidden-panel', !uiState.editorVisible); updateToggleButtons(); saveWorkspace(); setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250); }
      function togglePreview() { if (uiState.previewVisible && !uiState.editorVisible) return toast('è‡³å°‘éœ€è¦æ˜¾ç¤ºä¸€ä¸ªé¢æ¿'); uiState.previewVisible = !uiState.previewVisible; $('#previewPanel').classList.toggle('hidden-panel', !uiState.previewVisible); updateToggleButtons(); saveWorkspace(); setTimeout(() => { deck && deck.layout(); cm && cm.refresh(); }, 250); }

      if (!uiState.leftSidebarOpen) $('#leftSidebar').classList.add('collapsed');
      if (!uiState.rightSidebarOpen) $('#rightSidebar').classList.add('collapsed');
      if (!uiState.editorVisible) $('#editorPanel').classList.add('hidden-panel');
      if (!uiState.previewVisible) $('#previewPanel').classList.add('hidden-panel');
      updateToggleButtons();

      function applySettings() { $('#settingAutoSave').checked = settings.autoSave; $('#settingLineWrap').checked = settings.lineWrap; $('#settingFontSize').value = settings.fontSize; $('#settingTheme').value = settings.theme; $('#settingTransition').value = settings.transition; $('#settingControls').checked = settings.controls; $('#settingProgress').checked = settings.progress; $('#settingSlideNumber').checked = settings.slideNumber; $('#settingSyncSlide').checked = settings.syncSlide; $('#settingOverflowWarn').checked = settings.overflowWarn; $('#revealTheme').href = `https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/${settings.theme}.css`; if (cm) { cm.setOption('lineWrapping', settings.lineWrap); $('.CodeMirror').style.fontSize = settings.fontSize + 'px'; } if (deck) deck.configure({ transition: settings.transition, controls: settings.controls, progress: settings.progress, slideNumber: settings.slideNumber }); }
      $('#settingAutoSave').addEventListener('change', (e) => { settings.autoSave = e.target.checked; saveWorkspace(); });
      $('#settingLineWrap').addEventListener('change', (e) => { settings.lineWrap = e.target.checked; cm.setOption('lineWrapping', settings.lineWrap); saveWorkspace(); });
      $('#settingFontSize').addEventListener('change', (e) => { settings.fontSize = parseInt(e.target.value); $('.CodeMirror').style.fontSize = settings.fontSize + 'px'; cm.refresh(); saveWorkspace(); });
      $('#settingTheme').addEventListener('change', (e) => { settings.theme = e.target.value; $('#revealTheme').href = `https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/${settings.theme}.css`; saveWorkspace(); });
      $('#settingTransition').addEventListener('change', (e) => { settings.transition = e.target.value; if (deck) deck.configure({ transition: settings.transition }); saveWorkspace(); });
      $('#settingControls').addEventListener('change', (e) => { settings.controls = e.target.checked; if (deck) deck.configure({ controls: settings.controls }); saveWorkspace(); });
      $('#settingProgress').addEventListener('change', (e) => { settings.progress = e.target.checked; if (deck) deck.configure({ progress: settings.progress }); saveWorkspace(); });
      $('#settingSlideNumber').addEventListener('change', (e) => { settings.slideNumber = e.target.checked; if (deck) deck.configure({ slideNumber: settings.slideNumber }); saveWorkspace(); });
      $('#settingSyncSlide').addEventListener('change', (e) => { settings.syncSlide = e.target.checked; saveWorkspace(); });
      $('#settingOverflowWarn').addEventListener('change', (e) => { settings.overflowWarn = e.target.checked; saveWorkspace(); });

      function splitSlides(md) { const normalized = String(md || '').replace(/\r\n/g, '\n'); const h = normalized.split(/\n\s*---\s*\n/g); return h.map(part => part.split(/\n\s*--\s*\n/g)); }
      function renderSlideMarkdown(mdChunk) { const src = String(mdChunk || '').trim(); if (!src) return '<p style="opacity:0.5">ï¼ˆç©ºç™½é¡µï¼‰</p>'; return marked.parse(src); }
      function buildSlidesHtml(md) { const groups = splitSlides(md); let out = ''; for (const verticalGroup of groups) { if (verticalGroup.length > 1) { out += '<section>'; for (const v of verticalGroup) out += `<section>${renderSlideMarkdown(v)}</section>`; out += '</section>'; } else out += `<section>${renderSlideMarkdown(verticalGroup[0])}</section>`; } return out; }
      
      // æ ¹æ®å…‰æ ‡ä½ç½®è®¡ç®—å½“å‰å¹»ç¯ç‰‡ç´¢å¼•
      function getSlideIndexFromCursor() {
        if (!cm) return { h: 0, v: 0 };
        const cursor = cm.getCursor();
        const content = cm.getValue();
        const lines = content.split('\n');
        
        let h = 0, v = 0;
        let currentLine = 0;
        
        for (let i = 0; i < lines.length && currentLine <= cursor.line; i++) {
          const line = lines[i].trim();
          if (line === '---' && i > 0) {
            h++;
            v = 0;
          } else if (line === '--' && i > 0) {
            v++;
          }
          currentLine++;
        }
        
        return { h, v };
      }
      
      async function ensureDeck() { if (deck) return deck; deck = new Reveal($('#revealRoot'), { embedded: true, hash: false, controls: settings.controls, progress: settings.progress, slideNumber: settings.slideNumber, center: true, transition: settings.transition, backgroundTransition: 'fade', touch: true, touchDistance: 50, navigationMode: 'default', loop: false, plugins: [RevealNotes, RevealHighlight], keyboardCondition: 'focused' }); await deck.initialize(); deck.layout(); return deck; }
      function highlightPreview() { try { if (window.hljs) window.hljs.highlightAll(); } catch (_) {} }
      
      const requestPreviewUpdate = debounce(async () => { 
        const md = cm.getValue(); 
        const slidesEl = $('#slides'); 
        
        // å¦‚æœå¼€å¯äº†åŒæ­¥ï¼Œæ ¹æ®å…‰æ ‡ä½ç½®è®¡ç®—å¹»ç¯ç‰‡ç´¢å¼•
        let idx;
        if (settings.syncSlide) {
          idx = getSlideIndexFromCursor();
        } else {
          idx = deck ? deck.getIndices() : { h: 0, v: 0, f: 0 };
        }
        
        slidesEl.innerHTML = buildSlidesHtml(md); 
        const d = await ensureDeck(); 
        d.sync(); 
        d.layout(); 
        try { d.slide(idx.h, idx.v, idx.f || 0); } catch (_) {} 
        setTimeout(highlightPreview, 0); 
        if (settings.autoSave) saveCurrentFile({ silent: true });
        checkSlideOverflow();
      }, 260);

      const initialContent = workspace.activeFileId && workspace.files[workspace.activeFileId] ? workspace.files[workspace.activeFileId].content : '';
      cm = CodeMirror($('#editor'), { value: initialContent, mode: { name: 'markdown', fencedCodeBlocks: true, strikethrough: true, taskLists: true }, theme: 'material-darker', lineNumbers: true, lineWrapping: settings.lineWrap, indentUnit: 2, tabSize: 2, autofocus: false, extraKeys: { 'Ctrl-S': () => saveCurrentFile(), 'Cmd-S': () => saveCurrentFile(), 'Alt-Enter': () => toggleFullscreen(), 'Ctrl-N': () => createFile(null, getTargetParentId()), 'Cmd-N': () => createFile(null, getTargetParentId()), 'Ctrl-B': () => toggleLeftSidebar(), 'Cmd-B': () => toggleLeftSidebar() } });
      applySettings();
      if (workspace.activeFileId && workspace.files[workspace.activeFileId]) $('#currentFileName').textContent = workspace.files[workspace.activeFileId].name;
      renderStatus('å·²åŠ è½½'); renderFileTree(); $('#slides').innerHTML = buildSlidesHtml(initialContent);
      ensureDeck().then(() => setTimeout(highlightPreview, 0));
      cm.on('change', () => { setDirty(true); requestPreviewUpdate(); });
      
      // å…‰æ ‡ä½ç½®å˜åŒ–æ—¶åŒæ­¥å¹»ç¯ç‰‡
      cm.on('cursorActivity', () => {
        if (settings.syncSlide && deck) {
          const idx = getSlideIndexFromCursor();
          try { deck.slide(idx.h, idx.v, 0); } catch (_) {}
        }
      });

      $('#btnSave').onclick = () => saveCurrentFile();
      $('#btnToggleLeft').onclick = toggleLeftSidebar;
      $('#btnToggleRight').onclick = toggleRightSidebar;
      $('#btnToggleEditor').onclick = toggleEditor;
      $('#btnTogglePreview').onclick = togglePreview;
      $('#btnNewFile').onclick = () => createFile(null, getTargetParentId());
      $('#btnNewFolder').onclick = () => createFolder(null, getTargetParentId());
      $('#btnExportWorkspace').onclick = exportWorkspace;
      $('#btnImportWorkspace').onclick = () => { $('#workspaceInput').value = ''; $('#workspaceInput').click(); };
      $('#workspaceInput').onchange = (e) => { if (e.target.files[0]) importWorkspace(e.target.files[0]); };
      $('#btnClearWorkspace').onclick = () => { if (!confirm('æ¸…ç©ºæ‰€æœ‰ï¼Ÿ')) return; workspace = { files: {}, activeFileId: null, selectedItemId: null, expandedFolders: [] }; const id = generateId(); workspace.files[id] = { name: 'æœªå‘½å.md', content: '', parentId: null, type: 'file' }; workspace.activeFileId = id; saveWorkspace(); renderFileTree(); loadFile(id); toast('å·²æ¸…ç©º'); };
      $('#btnExport').onclick = () => { const blob = new Blob([cm.getValue()], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const fname = workspace.activeFileId ? workspace.files[workspace.activeFileId].name.replace(/\.[^.]+$/, '') : 'slides'; a.href = url; a.download = `${fname}.md`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); toast('å·²å¯¼å‡º'); };
      $('#btnImport').onclick = () => { $('#fileInput').value = ''; $('#fileInput').click(); };
      $('#fileInput').onchange = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = () => { const parentId = getTargetParentId(); const id = generateId(); workspace.files[id] = { name: file.name, content: reader.result, parentId, type: 'file' }; saveWorkspace(); renderFileTree(); loadFile(id); toast('å·²å¯¼å…¥'); }; reader.readAsText(file); };
      
      // PDF å¯¼å‡º
      $('#btnExportPDF').onclick = () => {
        const md = cm.getValue();
        const theme = settings.theme;
        const fname = workspace.activeFileId ? workspace.files[workspace.activeFileId].name.replace(/\.[^.]+$/, '') : 'slides';
        
        const groups = splitSlides(md);
        let flatSlides = [];
        groups.forEach(group => {
          group.forEach(slide => {
            flatSlides.push(renderSlideMarkdown(slide));
          });
        });
        
        const printWindow = window.open('', '_blank');
        if (!printWindow) { toast('æ— æ³•æ‰“å¼€çª—å£'); return; }
        
        const slidePagesHtml = flatSlides.map((content, i) => 
          `<div class="slide-page"><div class="slide-content">${content}</div><div class="slide-number">${i + 1} / ${flatSlides.length}</div></div>`
        ).join('');
        
        printWindow.document.write(`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>${fname} - PDF å¯¼å‡º</title>
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/dist/theme/${theme}.css">
  <link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/monokai.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    @page { size: A4 landscape; margin: 0; }
    html, body { width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .slide-page { width: 297mm; height: 210mm; padding: 15mm; display: flex; flex-direction: column; align-items: center; justify-content: center; page-break-after: always; page-break-inside: avoid; position: relative; background: var(--r-background-color, #191919); color: var(--r-main-color, #fff); -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
    .slide-page:last-child { page-break-after: auto; }
    .slide-content { width: 100%; max-width: 240mm; text-align: center; font-size: 24pt; line-height: 1.4; }
    .slide-content h1 { font-size: 48pt; margin-bottom: 0.5em; color: var(--r-heading-color, #fff); }
    .slide-content h2 { font-size: 36pt; margin-bottom: 0.5em; color: var(--r-heading-color, #fff); }
    .slide-content h3 { font-size: 28pt; margin-bottom: 0.5em; color: var(--r-heading-color, #fff); }
    .slide-content p { margin-bottom: 0.5em; font-size: 24pt; }
    .slide-content ul, .slide-content ol { text-align: left; display: inline-block; margin: 0.5em 0; font-size: 22pt; }
    .slide-content li { margin: 0.3em 0; }
    .slide-content pre { text-align: left; background: rgba(0,0,0,0.3); padding: 1em; border-radius: 8px; overflow: auto; font-size: 16pt; margin: 0.5em 0; }
    .slide-content code { font-family: 'Monaco', 'Menlo', monospace; font-size: 0.9em; }
    .slide-content table { margin: 0.5em auto; border-collapse: collapse; font-size: 20pt; }
    .slide-content th, .slide-content td { border: 1px solid rgba(255,255,255,0.3); padding: 0.4em 0.8em; }
    .slide-content img { max-width: 100%; max-height: 120mm; }
    .slide-content blockquote { border-left: 4px solid var(--r-link-color, #42affa); padding-left: 1em; margin: 0.5em 0; font-style: italic; text-align: left; font-size: 20pt; }
    .slide-number { position: absolute; bottom: 8mm; right: 10mm; font-size: 10pt; opacity: 0.5; }
    @media screen { body { background: #1e293b; padding-bottom: 40px; } .print-header { position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 16px 24px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #334155; flex-wrap: wrap; } .print-header h1 { font-size: 18px; color: white; font-weight: 600; } .print-header .info { color: #94a3b8; font-size: 13px; } .print-header .info strong { color: #60a5fa; } .print-header .spacer { flex: 1; } .print-header button { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; } .print-header .btn-print { background: #3b82f6; color: white; } .print-header .btn-print:hover { background: #2563eb; } .print-header .btn-close { background: #475569; color: white; } .print-header .btn-close:hover { background: #64748b; } .slides-container { display: flex; flex-direction: column; align-items: center; gap: 24px; padding: 24px; } .slide-page { width: 297mm; height: 210mm; transform: scale(0.35); transform-origin: top center; margin-bottom: -125mm; border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); } @media (min-width: 800px) { .slide-page { transform: scale(0.5); margin-bottom: -105mm; } } @media (min-width: 1200px) { .slide-page { transform: scale(0.7); margin-bottom: -63mm; } } }
    @media print { .print-header { display: none !important; } .slides-container { padding: 0; gap: 0; } .slide-page { width: 297mm !important; height: 210mm !important; max-width: none; border-radius: 0; box-shadow: none; } }
  </style>
</head>
<body>
  <div class="print-header"><h1>ğŸ“„ ${fname}</h1><div class="info">å…± <strong>${flatSlides.length}</strong> é¡µ Â· æ‰“å°è®¾ç½®ï¼š<strong>A4 æ¨ªå‘</strong>ã€è¾¹è·<strong>æ— </strong>ã€å‹¾é€‰<strong>èƒŒæ™¯å›¾å½¢</strong></div><div class="spacer"></div><button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ æ‰“å° / ä¿å­˜ PDF</button><button class="btn-close" onclick="window.close()">âœ• å…³é—­</button></div>
  <div class="slides-container">${slidePagesHtml}</div>
  <script src="https://gcore.jsdelivr.net/npm/reveal.js@4.6.1/plugin/highlight/highlight.js"><\/script>
  <script>if (typeof hljs !== 'undefined') { document.querySelectorAll('pre code').forEach(block => { hljs.highlightElement(block); }); }<\/script>
</body>
</html>`);
        printWindow.document.close();
        toast('PDF å¯¼å‡ºçª—å£å·²æ‰“å¼€');
      };

      // æ‰¹æ³¨ç³»ç»Ÿ
      const canvas = $('#annotationCanvas');
      const ctx = canvas.getContext('2d');
      const toolbar = $('#annotationToolbar');
      let annoState = { 
        tool: 'pointer', color: '#ef4444', strokeWidth: 4, 
        isDrawing: false, startX: 0, startY: 0, lastX: 0, lastY: 0, 
        currentPath: null, toolbarVisible: true,
        snapshot: null, history: []
      };

      function resizeCanvas() { 
        if (!isFullscreen) return; 
        const rect = canvas.parentElement.getBoundingClientRect(); 
        canvas.width = rect.width; 
        canvas.height = rect.height; 
      }
      
      function saveSnapshot() { annoState.snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height); }
      function restoreSnapshot() { if (annoState.snapshot) ctx.putImageData(annoState.snapshot, 0, 0); }
      function saveToHistory() { annoState.history.push(ctx.getImageData(0, 0, canvas.width, canvas.height)); if (annoState.history.length > 50) annoState.history.shift(); }
      function undo() { if (annoState.history.length > 0) ctx.putImageData(annoState.history.pop(), 0, 0); }
      
      function drawArrow(x1, y1, x2, y2, color, width) { 
        const head = Math.max(width * 3, 12); 
        const angle = Math.atan2(y2 - y1, x2 - x1); 
        ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
        ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); 
        ctx.beginPath(); ctx.fillStyle = color; ctx.moveTo(x2, y2); 
        ctx.lineTo(x2 - head * Math.cos(angle - Math.PI/6), y2 - head * Math.sin(angle - Math.PI/6)); 
        ctx.lineTo(x2 - head * Math.cos(angle + Math.PI/6), y2 - head * Math.sin(angle + Math.PI/6)); 
        ctx.closePath(); ctx.fill(); 
      }
      function drawLine(x1, y1, x2, y2, color, width) { ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.lineCap = 'round'; ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); }
      function drawRect(x1, y1, x2, y2, color, width) { ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.lineJoin = 'round'; ctx.strokeRect(Math.min(x1, x2), Math.min(y1, y2), Math.abs(x2 - x1), Math.abs(y2 - y1)); }
      function drawEllipse(x1, y1, x2, y2, color, width) { const cx = (x1 + x2) / 2, cy = (y1 + y2) / 2, rx = Math.abs(x2 - x1) / 2, ry = Math.abs(y2 - y1) / 2; ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width; ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2); ctx.stroke(); }
      function getPos(e) { const r = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return { x: cx - r.left, y: cy - r.top }; }
      
      function startDraw(e) { 
        if (!isFullscreen || annoState.tool === 'pointer') return; 
        e.preventDefault(); e.stopPropagation(); 
        const p = getPos(e); 
        annoState.isDrawing = true; annoState.startX = p.x; annoState.startY = p.y; annoState.lastX = p.x; annoState.lastY = p.y; 
        if (['line', 'arrow', 'rect', 'ellipse'].includes(annoState.tool)) saveSnapshot();
        saveToHistory();
        if (annoState.tool === 'pen' || annoState.tool === 'highlighter') annoState.currentPath = [{ x: p.x, y: p.y }];
      }
      
      function draw(e) { 
        if (!isFullscreen || !annoState.isDrawing || annoState.tool === 'pointer') return; 
        e.preventDefault(); e.stopPropagation(); 
        const p = getPos(e); 
        
        if (annoState.tool === 'pen') { 
          ctx.beginPath(); ctx.strokeStyle = annoState.color; ctx.lineWidth = annoState.strokeWidth; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; 
          ctx.moveTo(annoState.lastX, annoState.lastY); ctx.lineTo(p.x, p.y); ctx.stroke(); 
          if (annoState.currentPath) annoState.currentPath.push({ x: p.x, y: p.y }); 
        } else if (annoState.tool === 'highlighter') {
          ctx.beginPath(); ctx.strokeStyle = annoState.color; ctx.lineWidth = annoState.strokeWidth * 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.globalAlpha = 0.3;
          ctx.moveTo(annoState.lastX, annoState.lastY); ctx.lineTo(p.x, p.y); ctx.stroke(); ctx.globalAlpha = 1.0;
          if (annoState.currentPath) annoState.currentPath.push({ x: p.x, y: p.y });
        } else if (annoState.tool === 'line') { restoreSnapshot(); drawLine(annoState.startX, annoState.startY, p.x, p.y, annoState.color, annoState.strokeWidth); }
        else if (annoState.tool === 'arrow') { restoreSnapshot(); drawArrow(annoState.startX, annoState.startY, p.x, p.y, annoState.color, annoState.strokeWidth); }
        else if (annoState.tool === 'rect') { restoreSnapshot(); drawRect(annoState.startX, annoState.startY, p.x, p.y, annoState.color, annoState.strokeWidth); }
        else if (annoState.tool === 'ellipse') { restoreSnapshot(); drawEllipse(annoState.startX, annoState.startY, p.x, p.y, annoState.color, annoState.strokeWidth); }
        else if (annoState.tool === 'eraser') { ctx.globalCompositeOperation = 'destination-out'; ctx.beginPath(); ctx.arc(p.x, p.y, annoState.strokeWidth * 3, 0, Math.PI * 2); ctx.fill(); ctx.globalCompositeOperation = 'source-over'; }
        
        annoState.lastX = p.x; annoState.lastY = p.y; 
      }
      
      function stopDraw(e) { if (!isFullscreen || !annoState.isDrawing) return; annoState.isDrawing = false; annoState.currentPath = null; annoState.snapshot = null; }
      
      canvas.addEventListener('mousedown', startDraw); 
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDraw); 
      canvas.addEventListener('mouseleave', stopDraw);
      canvas.addEventListener('touchstart', startDraw, { passive: false }); 
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', stopDraw); 
      canvas.addEventListener('touchcancel', stopDraw);

      // å·¥å…·æŒ‰é’®
      $$('[data-tool]').forEach(b => b.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        annoState.tool = b.dataset.tool; 
        $$('[data-tool]').forEach(x => x.classList.remove('active')); 
        b.classList.add('active'); 
        if (annoState.tool === 'pointer') canvas.classList.remove('drawing-mode'); 
        else canvas.classList.add('drawing-mode'); 
      }));
      
      $('#btnAnnoStyle').addEventListener('click', (e) => { e.stopPropagation(); $('#stylePopup').classList.toggle('active'); });
      document.addEventListener('click', (e) => { if (!e.target.closest('#stylePopup') && !e.target.closest('#btnAnnoStyle')) $('#stylePopup').classList.remove('active'); });
      
      $$('.color-btn').forEach(b => b.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        annoState.color = b.dataset.color; 
        $$('.color-btn').forEach(x => x.classList.remove('active')); 
        b.classList.add('active'); 
        $('#currentStylePreview').style.backgroundColor = annoState.color; 
      }));
      
      $$('.stroke-dot').forEach(b => b.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        annoState.strokeWidth = parseInt(b.dataset.width); 
        $$('.stroke-dot').forEach(x => x.classList.remove('active')); 
        b.classList.add('active'); 
      }));
      
      $('#btnUndo').addEventListener('click', (e) => { e.stopPropagation(); undo(); });
      $('#btnClearAnno').addEventListener('click', (e) => { e.stopPropagation(); saveToHistory(); ctx.clearRect(0, 0, canvas.width, canvas.height); });
      $('#btnCloseToolbar').addEventListener('click', (e) => { e.stopPropagation(); annoState.toolbarVisible = false; toolbar.classList.remove('visible'); });
      $('#btnToggleAnno').addEventListener('click', (e) => { e.stopPropagation(); annoState.toolbarVisible = !annoState.toolbarVisible; toolbar.classList.toggle('visible', annoState.toolbarVisible); });

      async function toggleFullscreen() { const el = $('#previewWrap'); try { if (!document.fullscreenElement) await el.requestFullscreen(); else await document.exitFullscreen(); } catch (_) {} }
      
      function onFullscreenChange() { 
        isFullscreen = !!document.fullscreenElement; 
        $('#fsControls').classList.toggle('visible', isFullscreen); 
        toolbar.classList.toggle('visible', isFullscreen && annoState.toolbarVisible); 
        canvas.classList.toggle('fullscreen-active', isFullscreen); 
        if (isFullscreen) { 
          annoState.tool = 'pointer'; 
          $$('[data-tool]').forEach(b => b.classList.remove('active')); 
          $('[data-tool="pointer"]').classList.add('active'); 
          canvas.classList.remove('drawing-mode'); 
          setTimeout(() => { resizeCanvas(); deck && deck.layout(); }, 100); 
        } else { 
          annoState.paths = []; 
          ctx.clearRect(0, 0, canvas.width, canvas.height); 
          $('#stylePopup').classList.remove('active'); 
        } 
      }
      
      document.addEventListener('fullscreenchange', onFullscreenChange);
      $('#btnFullscreen').onclick = toggleFullscreen;
      $('#btnExitFs').onclick = () => document.exitFullscreen().catch(()=>{});

      // Help Modal
      function openHelp() { $('#helpModal').setAttribute('aria-hidden', 'false'); }
      function closeHelp() { $('#helpModal').setAttribute('aria-hidden', 'true'); }
      $('#btnHelp').onclick = openHelp;
      $('#btnCloseHelp').onclick = closeHelp;
      $('#helpModalBg').onclick = closeHelp;
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeHelp(); closeRenameModal(); } });
      
      // é¦–æ¬¡è®¿é—®æ—¶è‡ªåŠ¨æ‰“å¼€å¸®åŠ©
      if (settings.firstVisit) {
        setTimeout(() => {
          openHelp();
          settings.firstVisit = false;
          saveWorkspace();
        }, 500);
      }
      
      // å†…å®¹è¶…å‡ºæ£€æµ‹ - åŸºäº Markdown å†…å®¹çš„å¯å‘å¼æ£€æµ‹
      function checkSlideOverflow() {
        if (!settings.overflowWarn || !deck) return;
        
        // è·å–å½“å‰å¹»ç¯ç‰‡çš„ Markdown å†…å®¹
        const md = cm.getValue();
        const idx = getSlideIndexFromCursor();
        
        // åˆ†å‰²è·å–å½“å‰å¹»ç¯ç‰‡å†…å®¹
        const hSlides = md.split(/\n---\n/);
        if (idx.h >= hSlides.length) return;
        
        const vSlides = hSlides[idx.h].split(/\n--\n/);
        if (idx.v >= vSlides.length) return;
        
        const slideContent = vSlides[idx.v] || '';
        
        // å¯å‘å¼æ£€æµ‹ - æ›´æ•æ„Ÿçš„é˜ˆå€¼
        const lines = slideContent.split('\n');
        const nonEmptyLines = lines.filter(l => l.trim().length > 0).length;
        const totalChars = slideContent.length;
        const hasLargeCodeBlock = /```[\s\S]{300,}```/.test(slideContent);
        const listItems = (slideContent.match(/^[\s]*[-*+]\s/gm) || []).length;
        const hasHeading = /^#{1,3}\s/.test(slideContent);
        
        // æ ¹æ®å†…å®¹ç±»å‹è°ƒæ•´é˜ˆå€¼
        // å¦‚æœæœ‰æ ‡é¢˜ï¼Œå¯ç”¨ç©ºé—´æ›´å°‘
        const lineThreshold = hasHeading ? 12 : 15;
        const charThreshold = hasHeading ? 600 : 800;
        const listThreshold = hasHeading ? 8 : 10;
        
        // æ£€æµ‹æ˜¯å¦è¶…å‡º
        let overflow = false;
        if (nonEmptyLines > lineThreshold) overflow = true;
        if (totalChars > charThreshold) overflow = true;
        if (hasLargeCodeBlock) overflow = true;
        if (listItems > listThreshold) overflow = true;
        
        if (overflow) {
          toast('âš ï¸ å½“å‰é¡µå†…å®¹è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨ -- æ‹†åˆ†ä¸ºå­é¡µé¢');
        }
      }

      const editorPanel = $('#editorPanel');
      editorPanel.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
      editorPanel.addEventListener('drop', (e) => { e.preventDefault(); if(e.dataTransfer.files[0]) { const file = e.dataTransfer.files[0]; const reader = new FileReader(); reader.onload = () => { const parentId = getTargetParentId(); const id = generateId(); workspace.files[id] = { name: file.name, content: reader.result, parentId, type: 'file' }; saveWorkspace(); renderFileTree(); loadFile(id); toast('å·²å¯¼å…¥'); }; reader.readAsText(file); } });
      window.addEventListener('beforeunload', (e) => { if(dirty && !settings.autoSave) { e.preventDefault(); e.returnValue = ''; } });
      window.addEventListener('resize', debounce(() => { if(deck) deck.layout(); if(cm) cm.refresh(); if(isFullscreen) resizeCanvas(); }, 120));
      $('#previewWrap').addEventListener('pointerdown', () => $('#previewWrap').focus?.());
      if(settings.autoSave) saveCurrentFile({silent:true});
    })();
  </script>
</body>
</html>